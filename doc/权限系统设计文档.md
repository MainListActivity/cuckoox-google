# CuckooX 权限系统设计文档

## 概述

CuckooX 权限系统采用了 RBAC（基于角色的访问控制）模型，并扩展了数据级别的权限控制。系统支持三个层级的权限控制：

1. **菜单权限** - 控制用户可以访问哪些菜单
2. **操作权限** - 控制用户可以执行哪些操作
3. **数据权限** - 控制用户可以访问哪些数据

## 数据库设计

### 权限元数据表

#### menu_metadata（菜单元数据）
记录系统中所有的菜单项。

| 字段 | 类型 | 说明 |
|-----|------|------|
| menu_id | string | 菜单唯一标识 |
| path | string | 菜单路径 |
| label_key | string | i18n标签键 |
| icon_name | string | 图标名称 |
| parent_menu_id | string? | 父菜单ID |
| display_order | int | 显示顺序 |
| is_active | bool | 是否启用 |

#### operation_metadata（操作元数据）
记录每个菜单/页面中的操作。

| 字段 | 类型 | 说明 |
|-----|------|------|
| operation_id | string | 操作唯一标识 |
| menu_id | string | 关联的菜单ID |
| operation_name | string | 操作名称 |
| operation_type | string | 操作类型：create/read/update/delete/custom |
| description | string? | 操作描述 |
| is_active | bool | 是否启用 |

#### operation_table_relation（操作表关系）
记录每个操作涉及的数据表。

| 字段 | 类型 | 说明 |
|-----|------|------|
| operation_id | string | 操作ID |
| table_name | string | 数据表名称 |
| crud_type | string | CRUD类型 |
| condition_expr | string? | 权限条件表达式 |

### 权限分配表

#### role_menu_permission（角色菜单权限）
控制角色可以访问哪些菜单。

| 字段 | 类型 | 说明 |
|-----|------|------|
| role_id | record<role> | 角色ID |
| menu_id | string | 菜单ID |
| can_access | bool | 是否可访问 |

#### role_operation_permission（角色操作权限）
控制角色可以执行哪些操作。

| 字段 | 类型 | 说明 |
|-----|------|------|
| role_id | record<role> | 角色ID |
| operation_id | string | 操作ID |
| can_execute | bool | 是否可执行 |

#### data_permission_rule（数据权限规则）
定义角色对数据的访问规则。

| 字段 | 类型 | 说明 |
|-----|------|------|
| rule_id | string | 规则唯一标识 |
| role_id | record<role> | 角色ID |
| table_name | string | 数据表名称 |
| crud_type | string | CRUD类型 |
| rule_expression | string | 规则表达式 |
| priority | int | 优先级 |
| is_active | bool | 是否启用 |

## 预定义角色

系统预定义了以下角色：

1. **admin（系统管理员）**
   - 拥有所有权限
   - 可以管理系统配置和用户权限

2. **case_manager（案件管理人）**
   - 负责案件的全面管理
   - 可以创建和编辑案件
   - 可以管理债权人和债权
   - 可以安排会议

3. **creditor_representative（债权人代表）**
   - 可以申报和查看自己的债权
   - 可以参加会议
   - 可以使用消息中心

4. **assistant_lawyer（协办律师）**
   - 协助处理案件事务
   - 只能查看参与的案件
   - 不能编辑核心数据

5. **claim_reviewer（债权审核员）**
   - 负责审核债权申报
   - 只能查看和审核待审核的债权

## 权限检查流程

### 前端权限检查

使用自定义 Hook 进行权限检查：

```typescript
// 检查操作权限
const { hasPermission: canCreate } = useOperationPermission('creditor_create');

// 检查菜单权限
const { hasPermission: canAccessMenu } = useMenuPermission('cases');

// 检查数据权限
const { hasPermission: canEdit } = useDataPermission('case', 'update', caseData);
```

### 权限检查逻辑

1. **管理员特权**：如果用户是管理员（github_id === '--admin--'），直接返回 true

2. **角色收集**：
   - 获取用户在当前案件中的角色
   - 获取用户的全局角色

3. **权限查询**：
   - 菜单权限：查询 role_menu_permission 表
   - 操作权限：查询 role_operation_permission 表
   - 数据权限：查询 data_permission_rule 表并评估规则表达式

## 数据权限规则表达式

数据权限规则使用 SurrealDB 的查询语法，支持以下常见模式：

- `true` - 无条件允许
- `created_by = $auth.id` - 只能访问自己创建的数据
- `case_id IN (SELECT case_id FROM user_case_role WHERE user_id = $auth.id)` - 只能访问参与的案件

## 权限管理界面

系统提供了权限管理界面（/admin/manage/permissions），管理员可以：

1. **管理菜单元数据**
   - 添加/编辑/启用/禁用菜单项
   - 设置菜单路径和图标

2. **管理操作元数据**
   - 定义每个菜单的操作
   - 设置操作类型和关联的数据表

3. **管理数据权限规则**
   - 为角色配置数据访问规则
   - 设置规则表达式和优先级

## 使用示例

### 在页面中使用权限控制

```typescript
// 债权人管理页面
const CreditorListPage: React.FC = () => {
  // 权限检查
  const { hasPermission: canCreate } = useOperationPermission('creditor_create');
  const { hasPermission: canEdit } = useOperationPermission('creditor_edit');
  const { hasPermission: canDelete } = useOperationPermission('creditor_delete');

  return (
    <Box>
      {/* 根据权限显示按钮 */}
      {canCreate && (
        <Button onClick={handleCreate}>添加债权人</Button>
      )}
      
      {/* 列表中的操作按钮 */}
      {canEdit && (
        <IconButton onClick={() => handleEdit(creditor)}>
          <EditIcon />
        </IconButton>
      )}
    </Box>
  );
};
```

### 在路由中使用权限控制

```typescript
// App.tsx
<Route 
  path="/admin/manage/permissions" 
  element={
    <ProtectedRoute requiredRole="admin">
      <PermissionManagementPage />
    </ProtectedRoute>
  } 
/>
```

## 最佳实践

1. **最小权限原则**：给用户分配完成工作所需的最小权限集

2. **权限继承**：通过角色继承减少权限配置的复杂性

3. **审计日志**：记录权限变更和敏感操作

4. **定期审查**：定期审查用户权限，移除不必要的权限

5. **测试覆盖**：为权限相关功能编写完整的单元测试

## 扩展性

系统设计考虑了未来的扩展需求：

1. **字段级权限**：可以扩展到控制特定字段的访问

2. **动态权限**：支持基于业务规则的动态权限判断

3. **权限委托**：支持临时权限委托和代理

4. **审批流程**：集成权限申请和审批流程 