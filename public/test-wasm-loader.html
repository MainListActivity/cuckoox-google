<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASM Loader Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button {
            margin: 5px;
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        #log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>SurrealDB WASM Service Worker Test</h1>
    
    <div class="status info">
        <strong>状态:</strong> <span id="status">初始化中...</span>
    </div>
    
    <div>
        <button onclick="registerServiceWorker()">注册 Service Worker</button>
        <button onclick="testWasmLoader()">测试 WASM 加载器</button>
        <button onclick="testDatabaseConnection()">测试数据库连接</button>
        <button onclick="clearLog()">清空日志</button>
    </div>
    
    <h3>操作日志</h3>
    <div id="log"></div>
    
    <script>
        let sw = null;
        let messageId = 0;
        const pendingMessages = new Map();
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('log');
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logElement.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function updateStatus(text, type = 'info') {
            const statusElement = document.getElementById('status');
            statusElement.textContent = text;
            statusElement.parentElement.className = `status ${type}`;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // 发送消息到 Service Worker
        function sendMessage(type, payload = {}) {
            return new Promise((resolve, reject) => {
                if (!sw) {
                    reject(new Error('Service Worker not available'));
                    return;
                }
                
                const id = ++messageId;
                pendingMessages.set(id, { resolve, reject });
                
                sw.postMessage({
                    type,
                    messageId: id,
                    payload
                });
                
                // 超时处理
                setTimeout(() => {
                    if (pendingMessages.has(id)) {
                        pendingMessages.delete(id);
                        reject(new Error('Message timeout'));
                    }
                }, 10000);
            });
        }
        
        // 处理来自 Service Worker 的消息
        navigator.serviceWorker.addEventListener('message', (event) => {
            const { type, messageId, payload } = event.data;
            
            log(`收到 SW 消息: ${type}`, 'info');
            
            if (messageId && pendingMessages.has(messageId)) {
                const { resolve, reject } = pendingMessages.get(messageId);
                pendingMessages.delete(messageId);
                
                if (type.endsWith('_error')) {
                    reject(new Error(payload.message));
                } else {
                    resolve(payload);
                }
            }
        });
        
        async function registerServiceWorker() {
            try {
                log('正在注册 Service Worker...', 'info');
                updateStatus('注册 Service Worker 中...', 'info');
                
                const registration = await navigator.serviceWorker.register('/src/workers/sw-surreal.ts', {
                    type: 'module'
                });
                
                log('Service Worker 注册成功', 'success');
                
                if (registration.active) {
                    sw = registration.active;
                } else {
                    await new Promise((resolve) => {
                        const worker = registration.installing || registration.waiting;
                        if (worker) {
                            worker.addEventListener('statechange', () => {
                                if (worker.state === 'activated') {
                                    sw = worker;
                                    resolve();
                                }
                            });
                        }
                    });
                }
                
                updateStatus('Service Worker 已激活', 'success');
                log('Service Worker 已激活并可用', 'success');
                
            } catch (error) {
                log(`Service Worker 注册失败: ${error.message}`, 'error');
                updateStatus('Service Worker 注册失败', 'error');
            }
        }
        
        async function testWasmLoader() {
            try {
                log('测试 WASM 加载器...', 'info');
                
                // 测试是否能加载 WASM 文件
                const wasmResponse = await fetch('/wasm/surrealdb.wasm');
                if (wasmResponse.ok) {
                    const wasmSize = wasmResponse.headers.get('content-length');
                    log(`WASM 文件可访问，大小: ${wasmSize} bytes`, 'success');
                } else {
                    log(`WASM 文件不可访问: ${wasmResponse.status}`, 'error');
                }
                
                // 检查 Service Worker 中的 WASM 支持
                if (sw) {
                    log('检查 Service Worker WASM 支持...', 'info');
                    // 这里可以发送消息给 SW 测试 WASM 功能
                }
                
            } catch (error) {
                log(`WASM 加载器测试失败: ${error.message}`, 'error');
            }
        }
        
        async function testDatabaseConnection() {
            try {
                log('测试数据库连接...', 'info');
                
                if (!sw) {
                    throw new Error('Service Worker 未可用');
                }
                
                // 测试连接
                const connectResult = await sendMessage('connect', {
                    endpoint: 'mem://',
                    namespace: 'test',
                    database: 'test'
                });
                
                log(`连接结果: ${JSON.stringify(connectResult)}`, 'success');
                
                // 测试查询
                const queryResult = await sendMessage('query', {
                    sql: 'SELECT * FROM test',
                    vars: {}
                });
                
                log(`查询结果: ${JSON.stringify(queryResult)}`, 'success');
                
            } catch (error) {
                log(`数据库连接测试失败: ${error.message}`, 'error');
            }
        }
        
        // 页面加载时自动注册 Service Worker
        window.addEventListener('load', () => {
            registerServiceWorker();
        });
    </script>
</body>
</html>