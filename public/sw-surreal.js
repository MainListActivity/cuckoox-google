!function(){"use strict";
/**
     * uuidv7: A JavaScript implementation of UUID version 7
     *
     * Copyright 2021-2024 LiosK
     *
     * @license Apache-2.0
     * @packageDocumentation
     */const e="0123456789abcdef";class t{constructor(e){this.bytes=e}static ofInner(e){if(16!==e.length)throw new TypeError("not 128-bit length");return new t(e)}static fromFieldsV7(e,n,r,s){if(!Number.isInteger(e)||!Number.isInteger(n)||!Number.isInteger(r)||!Number.isInteger(s)||e<0||n<0||r<0||s<0||e>0xffffffffffff||n>4095||r>1073741823||s>4294967295)throw new RangeError("invalid field value");const i=new Uint8Array(16);return i[0]=e/2**40,i[1]=e/2**32,i[2]=e/2**24,i[3]=e/65536,i[4]=e/256,i[5]=e,i[6]=112|n>>>8,i[7]=n,i[8]=128|r>>>24,i[9]=r>>>16,i[10]=r>>>8,i[11]=r,i[12]=s>>>24,i[13]=s>>>16,i[14]=s>>>8,i[15]=s,new t(i)}static parse(e){var n,r,s,i;let a;switch(e.length){case 32:a=null===(n=/^[0-9a-f]{32}$/i.exec(e))||void 0===n?void 0:n[0];break;case 36:a=null===(r=/^([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})$/i.exec(e))||void 0===r?void 0:r.slice(1,6).join("");break;case 38:a=null===(s=/^\{([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})\}$/i.exec(e))||void 0===s?void 0:s.slice(1,6).join("");break;case 45:a=null===(i=/^urn:uuid:([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})$/i.exec(e))||void 0===i?void 0:i.slice(1,6).join("")}if(a){const e=new Uint8Array(16);for(let t=0;t<16;t+=4){const n=parseInt(a.substring(2*t,2*t+8),16);e[t+0]=n>>>24,e[t+1]=n>>>16,e[t+2]=n>>>8,e[t+3]=n}return new t(e)}throw new SyntaxError("could not parse UUID string")}toString(){let t="";for(let n=0;n<this.bytes.length;n++)t+=e.charAt(this.bytes[n]>>>4),t+=e.charAt(15&this.bytes[n]),3!==n&&5!==n&&7!==n&&9!==n||(t+="-");return t}toHex(){let t="";for(let n=0;n<this.bytes.length;n++)t+=e.charAt(this.bytes[n]>>>4),t+=e.charAt(15&this.bytes[n]);return t}toJSON(){return this.toString()}getVariant(){const e=this.bytes[8]>>>4;if(e<0)throw new Error("unreachable");if(e<=7)return this.bytes.every(e=>0===e)?"NIL":"VAR_0";if(e<=11)return"VAR_10";if(e<=13)return"VAR_110";if(e<=15)return this.bytes.every(e=>255===e)?"MAX":"VAR_RESERVED";throw new Error("unreachable")}getVersion(){return"VAR_10"===this.getVariant()?this.bytes[6]>>>4:void 0}clone(){return new t(this.bytes.slice(0))}equals(e){return 0===this.compareTo(e)}compareTo(e){for(let t=0;t<16;t++){const n=this.bytes[t]-e.bytes[t];if(0!==n)return Math.sign(n)}return 0}}class n{constructor(e){this.timestamp=0,this.counter=0,this.random=null!=e?e:r()}generate(){return this.generateOrResetCore(Date.now(),1e4)}generateOrAbort(){return this.generateOrAbortCore(Date.now(),1e4)}generateOrResetCore(e,t){let n=this.generateOrAbortCore(e,t);return void 0===n&&(this.timestamp=0,n=this.generateOrAbortCore(e,t)),n}generateOrAbortCore(e,n){if(!Number.isInteger(e)||e<1||e>0xffffffffffff)throw new RangeError("`unixTsMs` must be a 48-bit positive integer");if(n<0||n>0xffffffffffff)throw new RangeError("`rollbackAllowance` out of reasonable range");if(e>this.timestamp)this.timestamp=e,this.resetCounter();else{if(!(e+n>=this.timestamp))return;this.counter++,this.counter>4398046511103&&(this.timestamp++,this.resetCounter())}return t.fromFieldsV7(this.timestamp,Math.trunc(this.counter/2**30),this.counter&2**30-1,this.random.nextUint32())}resetCounter(){this.counter=1024*this.random.nextUint32()+(1023&this.random.nextUint32())}generateV4(){const e=new Uint8Array(Uint32Array.of(this.random.nextUint32(),this.random.nextUint32(),this.random.nextUint32(),this.random.nextUint32()).buffer);return e[6]=64|e[6]>>>4,e[8]=128|e[8]>>>2,t.ofInner(e)}}const r=()=>{if("undefined"!=typeof crypto&&void 0!==crypto.getRandomValues)return new s;if("undefined"!=typeof UUIDV7_DENY_WEAK_RNG&&UUIDV7_DENY_WEAK_RNG)throw new Error("no cryptographically strong RNG available");return{nextUint32:()=>65536*Math.trunc(65536*Math.random())+Math.trunc(65536*Math.random())}};class s{constructor(){this.buffer=new Uint32Array(8),this.cursor=65535}nextUint32(){return this.cursor>=this.buffer.length&&(crypto.getRandomValues(this.buffer),this.cursor=0),this.buffer[this.cursor++]}}let i;const a=function(){if("undefined"!=typeof WebSocket)return WebSocket;if(void 0!==global.WebSocket)return global.WebSocket;if(void 0!==window.WebSocket)return window.WebSocket;if(void 0!==self.WebSocket)return self.WebSocket;throw new Error("`WebSocket` is not supported in this environment")}();var o=Object.defineProperty,c=class{collectable={};listeners={};interceptors;constructor({interceptors:e}={}){this.interceptors=e??{}}subscribe(e,t,n=!1){if(this.listeners[e]||(this.listeners[e]=[]),!this.isSubscribed(e,t)&&(this.listeners[e]?.push(t),n&&this.collectable[e])){let n=this.collectable[e];delete this.collectable[e];for(let e of n)t(...e)}}async subscribeOnce(e,t=!1){if(t&&this.collectable[e]){let t=this.collectable[e]?.shift();if(0===this.collectable[e]?.length&&delete this.collectable[e],t)return t}return new Promise(t=>{let n=!1,r=(...s)=>{n||(n=!0,this.unSubscribe(e,r),t(s))};this.subscribe(e,r,!1)})}unSubscribe(e,t){if(this.listeners[e]){let n=this.listeners[e]?.findIndex(e=>e===t);n>=0&&(this.listeners[e]?.splice(n,1),0===this.listeners[e]?.length&&delete this.listeners[e])}}isSubscribed(e,t){return!!this.listeners[e]?.includes(t)}async emit(e,t,n=!1){let r=this.interceptors[e],s=r?await r(...t):t;(n&&!this.listeners[e]||0===this.listeners[e]?.length)&&(this.collectable[e]||(this.collectable[e]=[]),this.collectable[e]?.push(t));for(let t of this.listeners[e]??[])t(...s)}reset({collectable:e,listeners:t}){if(Array.isArray(e))for(let t of e)delete this.collectable[t];else"string"==typeof e?delete this.collectable[e]:!1!==e&&(this.collectable={});if(Array.isArray(t))for(let e of t)delete this.listeners[e];else"string"==typeof t?delete this.listeners[t]:!1!==t&&(this.listeners={})}scanListeners(e){let t=Object.keys(this.listeners);return e&&(t=t.filter(e)),t}},l=class{args=[];constructor(...e){this.args=e}fill(e){return[this,e]}hasDefault(){return 1===this.args.length}get default(){return this.args[0]}};((e,t)=>{for(var n in t)o(e,n,{get:t[n],enumerable:!0})})({},{CborBreak:()=>D,CborError:()=>C,CborFillMissing:()=>T,CborInvalidMajorError:()=>j,CborNumberError:()=>R,CborPartialDisabled:()=>L,CborRangeError:()=>O,Encoded:()=>d,Gap:()=>l,POW_2_53:()=>h,POW_2_64:()=>u,PartiallyEncoded:()=>q,Reader:()=>V,Tagged:()=>J,Writer:()=>W,decode:()=>G,encode:()=>F,infiniteBytes:()=>z,partiallyEncodeObject:()=>I});var h=9007199254740992,u=BigInt(0x10000000000000000),d=class{constructor(e){this.encoded=e}},f=class extends Error{},w=class extends f{name="NoActiveSocket";message="No socket is currently connected to a SurrealDB instance. Please call the .connect() method first!"},p=class extends f{name="NoURLProvided";message="Tried to establish a connection while no connection URL was provided"},g=class extends f{name="EngineDisconnected";message="The engine reported the connection to SurrealDB has dropped"},m=class extends f{name="ReconnectFailed";message="The engine failed to reconnect to SurrealDB"},y=class extends f{name="ReconnectIterationError";message="The reconnect iterator failed to iterate"},b=class extends f{constructor(e){super(),this.response=e,this.message=`${e}`}name="UnexpectedServerResponse"},v=class extends f{constructor(e){super(),this.error=e,this.message=`${e}`}name="UnexpectedConnectionError"},_=class extends f{constructor(e){super(),this.engine=e}name="UnsupportedEngine";message="The engine you are trying to connect to is not supported or configured."},k=class extends f{name="ConnectionUnavailable";message="There is no connection available at this moment."},S=class extends f{name="MissingNamespaceDatabase";message="There is no namespace and/or database selected."},x=class extends f{constructor(e,t,n,r){super(),this.message=e,this.status=t,this.statusText=n,this.buffer=r}name="HttpConnectionError"},A=class extends f{constructor(e){super(),this.message=e}name="ResponseError"},U=class extends f{name="NoNamespaceSpecified";message="Please specify a namespace to use."},E=class extends f{name="NoDatabaseSpecified";message="Please specify a database to use."},N=class extends f{name="NoTokenReturned";message="Did not receive an authentication token."},$=class extends f{name="UnsupportedVersion";version;supportedRange;constructor(e,t){super(),this.version=e,this.supportedRange=t,this.message=`The version "${e}" reported by the engine is not supported by this library, expected a version that satisfies "${t}".`}},M=class extends f{constructor(e){super(),this.error=e}name="VersionRetrievalFailure";message="Failed to retrieve remote version. If the server is behind a proxy, make sure it's configured correctly."},C=class extends f{message;constructor(e){super(),this.message=e}},R=class extends C{name="CborNumberError"},O=class extends C{name="CborRangeError"},j=class extends C{name="CborInvalidMajorError"},D=class extends C{name="CborBreak";constructor(){super("Came across a break which was not intercepted by the decoder")}},L=class extends C{name="CborPartialDisabled";constructor(){super("Tried to insert a Gap into a CBOR value, while partial mode is not enabled")}},T=class extends C{name="CborFillMissing";constructor(){super("Fill for a gap is missing, and gap has no default")}},W=class{constructor(e=256){this.byteLength=e,this._buf=new ArrayBuffer(this.byteLength),this._view=new DataView(this._buf),this._byte=new Uint8Array(this._buf)}_chunks=[];_pos=0;_buf;_view;_byte;chunk(e){this._chunks.push([this._buf.slice(0,this._pos),e]),this._buf=new ArrayBuffer(this.byteLength),this._view=new DataView(this._buf),this._byte=new Uint8Array(this._buf),this._pos=0}get chunks(){return this._chunks}get buffer(){return this._buf.slice(0,this._pos)}claim(e){let t=this._pos;if(this._pos+=e,this._pos<=this._buf.byteLength)return t;let n=this._buf.byteLength<<1;for(;n<this._pos;)n<<=1;if(n>this._buf.byteLength){let e=this._byte;this._buf=new ArrayBuffer(n),this._view=new DataView(this._buf),this._byte=new Uint8Array(this._buf),this._byte.set(e)}return t}writeUint8(e){let t=this.claim(1);this._view.setUint8(t,e)}writeUint16(e){let t=this.claim(2);this._view.setUint16(t,e)}writeUint32(e){let t=this.claim(4);this._view.setUint32(t,e)}writeUint64(e){let t=this.claim(8);this._view.setBigUint64(t,e)}writeUint8Array(e){if(0===e.byteLength)return;let t=this.claim(e.byteLength);this._byte.set(e,t)}writeArrayBuffer(e){0!==e.byteLength&&this.writeUint8Array(new Uint8Array(e))}writePartiallyEncoded(e){for(let[t,n]of e.chunks)this.writeArrayBuffer(t),this.chunk(n);this.writeArrayBuffer(e.end)}writeFloat32(e){let t=this.claim(4);this._view.setFloat32(t,e)}writeFloat64(e){let t=this.claim(8);this._view.setFloat64(t,e)}writeMajor(e,t){let n=e<<5;t<24?this.writeUint8(n+Number(t)):t<256?(this.writeUint8(n+24),this.writeUint8(Number(t))):t<65536?(this.writeUint8(n+25),this.writeUint16(Number(t))):t<4294967296?(this.writeUint8(n+26),this.writeUint32(Number(t))):(this.writeUint8(n+27),this.writeUint64(BigInt(t)))}output(e,t){return e?new q(this._chunks,this.buffer,t):this.buffer}},q=class{constructor(e,t,n){this.chunks=e,this.end=t,this.replacer=n}build(e,t){let n=new W,r=new Map(e);for(let[e,s]of this.chunks){let i=r.has(s)||s.hasDefault();if(!t&&!i)throw new T;if(n.writeArrayBuffer(e),i){F(r.get(s)??s.default,{writer:n,replacer:this.replacer})}else n.chunk(s)}return n.writeArrayBuffer(this.end),n.output(!!t,this.replacer)}};function I(e,t){return Object.fromEntries(Object.entries(e).map(([e,n])=>[e,F(n,{...t,partial:!0})]))}var B,J=class{constructor(e,t){this.tag=e,this.value=t}};function F(e,t={}){let n=t.writer??new W,r=new Map(t.fills??[]);return function e(s){let i=t.replacer?t.replacer(s):s;if(void 0===i)return n.writeUint8(247);if(null===i)return n.writeUint8(246);if(!0===i)return n.writeUint8(245);if(!1===i)return n.writeUint8(244);switch(typeof i){case"number":if(Number.isInteger(i))if(i>=0&&i<=9007199254740992)n.writeMajor(0,i);else{if(!(i<0&&i>=-9007199254740992))throw new R("Number too big to be encoded");n.writeMajor(1,-(i+1))}else n.writeUint8(251),n.writeFloat64(i);return;case"bigint":if(i>=0&&i<u)n.writeMajor(0,i);else{if(!(i<=0&&i>=-u))throw new R("BigInt too big to be encoded");n.writeMajor(1,-(i+1n))}return;case"string":{B??=new TextEncoder;let e=B.encode(i);return n.writeMajor(3,e.byteLength),void n.writeUint8Array(e)}default:{if(Array.isArray(i)){n.writeMajor(4,i.length);for(let t of i)e(t);return}if(i instanceof J)return n.writeMajor(6,i.tag),void e(i.value);if(i instanceof d)return void n.writeArrayBuffer(i.encoded);if(i instanceof l){if(r.has(i))e(r.get(i));else{if(!t.partial)throw new L;n.chunk(i)}return}if(i instanceof q){let e=i.build(t.fills??[],t.partial);return void(t.partial?n.writePartiallyEncoded(e):n.writeArrayBuffer(e))}if(i instanceof Uint8Array||i instanceof Uint16Array||i instanceof Uint32Array||i instanceof Int8Array||i instanceof Int16Array||i instanceof Int32Array||i instanceof Float32Array||i instanceof Float64Array||i instanceof ArrayBuffer){let e=new Uint8Array(i);return n.writeMajor(2,e.byteLength),void n.writeUint8Array(e)}let s=i instanceof Map?Array.from(i.entries()):Object.entries(i);n.writeMajor(5,s.length);for(let t of s.flat())e(t)}}}(e),n.output(!!t.partial,t.replacer)}var P,V=class{_buf;_view;_byte;_pos=0;constructor(e){this._buf=new ArrayBuffer(e.byteLength),this._view=new DataView(this._buf),this._byte=new Uint8Array(this._buf),this._byte.set(new Uint8Array(e))}read(e,t){return this._pos+=e,t}readUint8(){try{return this.read(1,this._view.getUint8(this._pos))}catch(e){throw e instanceof RangeError?new O(e.message):e}}readUint16(){try{return this.read(2,this._view.getUint16(this._pos))}catch(e){throw e instanceof RangeError?new O(e.message):e}}readUint32(){try{return this.read(4,this._view.getUint32(this._pos))}catch(e){throw e instanceof RangeError?new O(e.message):e}}readUint64(){try{return this.read(8,this._view.getBigUint64(this._pos))}catch(e){throw e instanceof RangeError?new O(e.message):e}}readFloat16(){let e=this.readUint16(),t=(32768&e)>>15,n=(31744&e)>>10,r=1023&e;return 0===n?(t?-1:1)*2**-14*(r/1024):31===n?r?Number.NaN:(t?-1:1)*Number.POSITIVE_INFINITY:(t?-1:1)*2**(n-15)*(1+r/1024)}readFloat32(){try{return this.read(4,this._view.getFloat32(this._pos))}catch(e){throw e instanceof RangeError?new O(e.message):e}}readFloat64(){try{return this.read(8,this._view.getFloat64(this._pos))}catch(e){throw e instanceof RangeError?new O(e.message):e}}readBytes(e){let t=this._byte.length-this._pos;if(t<e)throw new O(`The argument must be between 0 and ${t}`);return this.read(e,this._byte.slice(this._pos,this._pos+e))}readMajor(){let e=this.readUint8(),t=e>>5;if(t<0||t>7)throw new j("Received invalid major type");return[t,31&e]}readMajorLength(e){if(e<=23)return e;switch(e){case 24:return this.readUint8();case 25:return this.readUint16();case 26:return this.readUint32();case 27:{let e=this.readUint64();return e>9007199254740992?e:Number(e)}}throw new O("Expected a final length")}};function z(e,t){let n=new W;for(;;){let[r,s]=e.readMajor();if(7===r&&31===s)break;if(r!==t)throw new j(`Expected a resource of the same major (${t}) while processing an infinite resource`);if(31===s)throw new O("Expected a finite resource while processing an infinite resource");n.writeUint8Array(e.readBytes(Number(e.readMajorLength(s))))}return n.buffer}function G(e,t={}){let n=e instanceof V?e:new V(e);function r(){let[e,r]=n.readMajor();switch(e){case 0:return n.readMajorLength(r);case 1:{let e=n.readMajorLength(r);return"bigint"==typeof e?-(e+1n):-(e+1)}case 2:return 31===r?z(n,2):n.readBytes(Number(n.readMajorLength(r))).buffer;case 3:{let e=31===r?z(n,3):n.readBytes(Number(n.readMajorLength(r)));return P??=new TextDecoder,P.decode(e)}case 4:{if(31===r){let e=[];for(;;)try{e.push(s())}catch(e){if(e instanceof D)break;throw e}return e}let e=n.readMajorLength(r),t=Array(e);for(let n=0;n<e;n++)t[n]=s();return t}case 5:{let e=[];if(31===r)for(;;){let t;try{t=s()}catch(e){if(e instanceof D)break;throw e}let n=s();e.push([t,n])}else{let t=n.readMajorLength(r);for(let n=0;n<t;n++){let t=s(),r=s();e[n]=[t,r]}}return"map"===t.map?new Map(e):Object.fromEntries(e)}case 6:{let e=n.readMajorLength(r),t=s();return new J(e,t)}case 7:switch(r){case 20:return!1;case 21:return!0;case 22:return null;case 23:return;case 25:return n.readFloat16();case 26:return n.readFloat32();case 27:return n.readFloat64();case 31:throw new D}}throw new j(`Unable to decode value with major tag ${e}`)}function s(){return t.replacer?t.replacer(r()):r()}return s()}var K=class{},Y=class e extends K{decimal;constructor(e){super(),this.decimal=e.toString()}equals(t){return t instanceof e&&this.decimal===t.decimal}toString(){return this.decimal}toJSON(){return this.decimal}},H=.001,X=1e-6,Q=1e3,Z=6e4,ee=36e5,te=24*ee,ne=7*te,re=new Map([["ns",X],["µs",H],["μs",H],["us",H],["ms",1],["s",Q],["m",Z],["h",ee],["d",te],["w",ne]]),se=Array.from(re).reduce((e,[t,n])=>(e.set(n,t),e),new Map),ie=new RegExp(`^(\\d+)(${Array.from(re.keys()).join("|")})`),ae=class e extends K{_milliseconds;constructor(t){super(),this._milliseconds=t instanceof e?t._milliseconds:"string"==typeof t?e.parseString(t):t}static fromCompact([t,n]){return new e(1e3*(t=t??0)+(n=n??0)/1e6)}equals(t){return t instanceof e&&this._milliseconds===t._milliseconds}toCompact(){let e=Math.floor(this._milliseconds/1e3),t=Math.floor(1e6*(this._milliseconds-1e3*e));return t>0?[e,t]:e>0?[e]:[]}toString(){let e=this._milliseconds,t="";function n(t){let n=Math.floor(e/t);return n>0&&(e%=t),n}for(let[e,r]of Array.from(se).reverse()){let s=n(e);s>0&&(t+=`${s}${r}`)}return t}toJSON(){return this.toString()}static parseString(e){let t=0,n=e;for(;""!==n;){let e=n.match(ie);if(e){let r=Number.parseInt(e[1]),s=re.get(e[2]);if(void 0===s)throw new f(`Invalid duration unit: ${e[2]}`);t+=r*s,n=n.slice(e[0].length);continue}throw new f("Could not match a next duration part")}return t}static nanoseconds(t){return new e(Math.floor(t*X))}static microseconds(t){return new e(Math.floor(t*H))}static milliseconds(t){return new e(t)}static seconds(t){return new e(t*Q)}static minutes(t){return new e(t*Z)}static hours(t){return new e(t*ee)}static days(t){return new e(t*te)}static weeks(t){return new e(t*ne)}get microseconds(){return Math.floor(this._milliseconds/H)}get nanoseconds(){return Math.floor(this._milliseconds/X)}get milliseconds(){return Math.floor(this._milliseconds)}get seconds(){return Math.floor(this._milliseconds/Q)}get minutes(){return Math.floor(this._milliseconds/Z)}get hours(){return Math.floor(this._milliseconds/ee)}get days(){return Math.floor(this._milliseconds/te)}get weeks(){return Math.floor(this._milliseconds/ne)}},oe=class e extends K{constructor(e){super(),this.inner=e}equals(t){return t instanceof e&&this.inner===t.inner}toJSON(){return this.toString()}toString(){return`<future> ${this.inner}`}},ce=class e extends K{equals(t){return t instanceof e&&this.is(t)}toString(){return JSON.stringify(this.toJSON())}};function le(e){return e instanceof Y?Number.parseFloat(e.decimal):e}var he=class e extends ce{point;constructor(t){super(),this.point=t instanceof e?t.clone().point:[le(t[0]),le(t[1])]}toJSON(){return{type:"Point",coordinates:this.coordinates}}get coordinates(){return this.point}is(t){return t instanceof e&&(this.point[0]===t.point[0]&&this.point[1]===t.point[1])}clone(){return new e([...this.point])}},ue=class e extends ce{line;constructor(t){super(),this.line=t instanceof e?t.clone().line:t}toJSON(){return{type:"LineString",coordinates:this.coordinates}}get coordinates(){return this.line.map(e=>e.coordinates)}close(){this.line[0].is(this.line.at(-1))||this.line.push(this.line[0])}is(t){if(!(t instanceof e)||this.line.length!==t.line.length)return!1;for(let e=0;e<this.line.length;e++)if(!this.line[e].is(t.line[e]))return!1;return!0}clone(){return new e(this.line.map(e=>e.clone()))}},de=class e extends ce{polygon;constructor(t){super(),this.polygon=t instanceof e?t.clone().polygon:t.map(e=>{let t=e.clone();return t.close(),t})}toJSON(){return{type:"Polygon",coordinates:this.coordinates}}get coordinates(){return this.polygon.map(e=>e.coordinates)}is(t){if(!(t instanceof e)||this.polygon.length!==t.polygon.length)return!1;for(let e=0;e<this.polygon.length;e++)if(!this.polygon[e].is(t.polygon[e]))return!1;return!0}clone(){return new e(this.polygon.map(e=>e.clone()))}},fe=class e extends ce{points;constructor(t){super(),this.points=t instanceof e?t.points:t}toJSON(){return{type:"MultiPoint",coordinates:this.coordinates}}get coordinates(){return this.points.map(e=>e.coordinates)}is(t){if(!(t instanceof e)||this.points.length!==t.points.length)return!1;for(let e=0;e<this.points.length;e++)if(!this.points[e].is(t.points[e]))return!1;return!0}clone(){return new e(this.points.map(e=>e.clone()))}},we=class e extends ce{lines;constructor(t){super(),this.lines=t instanceof e?t.lines:t}toJSON(){return{type:"MultiLineString",coordinates:this.coordinates}}get coordinates(){return this.lines.map(e=>e.coordinates)}is(t){if(!(t instanceof e)||this.lines.length!==t.lines.length)return!1;for(let e=0;e<this.lines.length;e++)if(!this.lines[e].is(t.lines[e]))return!1;return!0}clone(){return new e(this.lines.map(e=>e.clone()))}},pe=class e extends ce{polygons;constructor(t){super(),this.polygons=t instanceof e?t.polygons:t}toJSON(){return{type:"MultiPolygon",coordinates:this.coordinates}}get coordinates(){return this.polygons.map(e=>e.coordinates)}is(t){if(!(t instanceof e)||this.polygons.length!==t.polygons.length)return!1;for(let e=0;e<this.polygons.length;e++)if(!this.polygons[e].is(t.polygons[e]))return!1;return!0}clone(){return new e(this.polygons.map(e=>e.clone()))}},ge=class e extends ce{collection;constructor(t){super(),this.collection=t instanceof e?t.collection:t}toJSON(){return{type:"GeometryCollection",geometries:this.geometries}}get geometries(){return this.collection.map(e=>e.toJSON())}is(t){if(!(t instanceof e)||this.collection.length!==t.collection.length)return!1;for(let e=0;e<this.collection.length;e++)if(!this.collection[e].is(t.collection[e]))return!1;return!0}clone(){return new e(this.collection.map(e=>e.clone()))}};function me(e,t){if(Object.is(e,t))return!0;if(e instanceof Date&&t instanceof Date)return e.getTime()===t.getTime();if(e instanceof RegExp&&t instanceof RegExp)return e.toString()===t.toString();if(e instanceof K&&t instanceof K)return e.equals(t);if("object"!=typeof e||null===e||"object"!=typeof t||null===t)return!1;let n=Reflect.ownKeys(e),r=Reflect.ownKeys(t);if(n.length!==r.length)return!1;for(let r=0;r<n.length;r++)if(!Reflect.has(t,n[r])||!me(e[n[r]],t[n[r]]))return!1;return!0}function ye(e){if(function(e){return/^\d+$/.test(e.replace(/_/g,""))}(e))return`⟨${e}⟩`;if(""===e)return"⟨⟩";let t,n,r;for(n=0,r=e.length;n<r;n++)if(t=e.charCodeAt(n),!(t>47&&t<58||t>64&&t<91||t>96&&t<123||95===t))return`⟨${e.replaceAll("⟩","\\⟩")}⟩`;return e}var be=class e extends K{inner;constructor(n){super(),n instanceof ArrayBuffer?this.inner=t.ofInner(new Uint8Array(n)):n instanceof Uint8Array?this.inner=t.ofInner(n):this.inner=n instanceof e?n.inner:n instanceof t?n:t.parse(n)}equals(t){return t instanceof e&&this.inner.equals(t.inner)}toString(){return this.inner.toString()}toJSON(){return this.inner.toString()}toUint8Array(){return this.inner.bytes}toBuffer(){return this.inner.bytes.buffer}static v4(){return new e((i||(i=new n)).generateV4())}static v7(){return new e((i||(i=new n)).generate())}},ve=class e extends K{tb;id;constructor(e,t){if(super(),"string"!=typeof e)throw new f("TB part is not valid");if(!ke(t))throw new f("ID part is not valid");this.tb=e,this.id=t}equals(t){return t instanceof e&&(this.tb===t.tb&&me(this.id,t.id))}toJSON(){return this.toString()}toString(){return`${ye(this.tb)}:${Se(this.id)}`}},_e=class e extends K{rid;constructor(t){if(super(),t instanceof e)this.rid=t.rid;else if(t instanceof ve)this.rid=t.toString();else{if("string"!=typeof t)throw new f("String Record ID must be a string");this.rid=t}}equals(t){return t instanceof e&&this.rid===t.rid}toJSON(){return this.rid}toString(){return this.rid}};function ke(e){if(e instanceof be)return!0;switch(typeof e){case"string":case"number":case"bigint":return!0;case"object":return Array.isArray(e)||null!==e;default:return!1}}function Se(e){return e instanceof be?`u"${e}"`:"string"==typeof e?ye(e):"bigint"==typeof e||"number"==typeof e?(t=e)<=9223372036854775807n?t.toString():`⟨${t}⟩`:Ae(e);var t}var xe=class e extends K{tb;constructor(e){if(super(),"string"!=typeof e)throw new f("Table must be a string");this.tb=e}equals(t){return t instanceof e&&this.tb===t.tb}toJSON(){return this.tb}toString(){return this.tb}};function Ae(e){if("string"==typeof e)return`s${JSON.stringify(e)}`;if(null===e)return"NULL";if(void 0===e)return"NONE";if("object"==typeof e){if(e instanceof Date)return`d${JSON.stringify(e.toISOString())}`;if(e instanceof be)return`u${JSON.stringify(e.toString())}`;if(e instanceof ve||e instanceof _e)return`r${JSON.stringify(e.toString())}`;if(e instanceof ce)return Ae(e.toJSON());if(e instanceof Y||e instanceof ae||e instanceof oe||e instanceof Ue||e instanceof xe)return e.toJSON();switch(Object.getPrototypeOf(e)){case Object.prototype:{let t="{ ",n=Object.entries(e);for(let[e,[r,s]]of n.entries())t+=`${JSON.stringify(r)}: ${Ae(s)}`,e<n.length-1&&(t+=", ");return t+=" }",t}case Map.prototype:{let t="{ ",n=Array.from(e.entries());for(let[e,[r,s]]of n.entries())t+=`${JSON.stringify(r)}: ${Ae(s)}`,e<n.length-1&&(t+=", ");return t+=" }",t}case Array.prototype:return`[ ${e.map(Ae).join(", ")} ]`;case Set.prototype:return`[ ${[...new Set([...e].map(Ae))].join(", ")} ]`}}return`${e}`}var Ue=class e extends K{constructor(e,t){super(),this.beg=e,this.end=t}equals(t){return t instanceof e&&this.beg?.constructor===t.beg?.constructor&&this.end?.constructor===t.end?.constructor&&(me(this.beg?.value,t.beg?.value)&&me(this.end?.value,t.end?.value))}toJSON(){return this.toString()}toString(){let e=Oe(this.beg),t=Oe(this.end);return`${e}${Me(this.beg,this.end)}${t}`}},Ee=class{constructor(e){this.value=e}},Ne=class{constructor(e){this.value=e}},$e=class e extends K{constructor(e,t,n){if(super(),this.tb=e,this.beg=t,this.end=n,"string"!=typeof e)throw new f("TB part is not valid");if(!Ce(t))throw new f("Beg part is not valid");if(!Ce(n))throw new f("End part is not valid")}equals(t){return t instanceof e&&this.beg?.constructor===t.beg?.constructor&&this.end?.constructor===t.end?.constructor&&(this.tb===t.tb&&me(this.beg?.value,t.beg?.value)&&me(this.end?.value,t.end?.value))}toJSON(){return this.toString()}toString(){let e=ye(this.tb),t=Re(this.beg),n=Re(this.end);return`${e}:${t}${Me(this.beg,this.end)}${n}`}};function Me(e,t){let n="";return e instanceof Ne&&(n+=">"),n+="..",t instanceof Ee&&(n+="="),n}function Ce(e){return!(e instanceof Ee||e instanceof Ne)||ke(e.value)}function Re(e){return e instanceof Ee||e instanceof Ne?Se(e.value):""}function Oe(e){if(void 0===e)return"";let t=e.value;return e instanceof Ue?`(${Ae(t)})`:Ae(t)}function je([e,t]){function n(e){return e instanceof Ee?new J(De,e.value):e instanceof Ne?new J(Le,e.value):null}return[n(e),n(t)]}var De=50,Le=51,Te={encode:e=>e instanceof Date?new J(12,function(e){let t=Math.floor(e.getTime()/1e3);return[t,1e6*(e.getTime()-1e3*t)]}(e)):void 0===e?new J(6,null):e instanceof be?new J(37,e.toBuffer()):e instanceof Y?new J(10,e.toString()):e instanceof ae?new J(14,e.toCompact()):e instanceof ve?new J(8,[e.tb,e.id]):e instanceof _e?new J(8,e.rid):e instanceof $e?new J(8,[e.tb,new J(49,je([e.beg,e.end]))]):e instanceof xe?new J(7,e.tb):e instanceof oe?new J(15,e.inner):e instanceof Ue?new J(49,je([e.beg,e.end])):e instanceof he?new J(88,e.point):e instanceof ue?new J(89,e.line):e instanceof de?new J(90,e.polygon):e instanceof fe?new J(91,e.points):e instanceof we?new J(92,e.lines):e instanceof pe?new J(93,e.polygons):e instanceof ge?new J(94,e.collection):e,decode(e){if(!(e instanceof J))return e;switch(e.tag){case 0:return new Date(e.value);case 37:case 9:return new be(e.value);case 12:return function([e,t]){let n=new Date(0);return n.setUTCSeconds(Number(e)),n.setMilliseconds(Math.floor(Number(t)/1e6)),n}(e.value);case 6:return;case 10:return new Y(e.value);case 13:return new ae(e.value);case 14:return ae.fromCompact(e.value);case 7:return new xe(e.value);case 15:return new oe(e.value);case 49:return new Ue(...function(e){function t(e){if(null!==e){if(e instanceof Ee||e instanceof Ne)return e;throw new f("Expected the bounds to be decoded already")}}return[t(e[0]),t(e[1])]}(e.value));case De:return new Ee(e.value);case Le:return new Ne(e.value);case 8:return e.value[1]instanceof Ue?new $e(e.value[0],e.value[1].beg,e.value[1].end):new ve(e.value[0],e.value[1]);case 88:return new he(e.value);case 89:return new ue(e.value);case 90:return new de(e.value);case 91:return new fe(e.value);case 92:return new we(e.value);case 93:return new pe(e.value);case 94:return new ge(e.value)}}};function We(e){return F(e,{replacer:Te.encode})}function qe(e){return G(e,{replacer:Te.decode})}Object.freeze(Te);var Ie,Be=class{_query;_bindings;length;constructor(e,t){Ie??=new TextEncoder,this._query=Ie.encode(e),this._bindings=I(t??{},{replacer:Te.encode}),this.length=Object.keys(this._bindings).length}get query(){let e=new W(this._query.byteLength+9);return e.writeMajor(3,this._query.byteLength),e.writeUint8Array(this._query),new d(e.output(!1))}get bindings(){return this._bindings}build(e){return F([this.query,this.bindings],{fills:e})}append(e,...t){let n=this.length;this.length+=t.length;let r=0,s=new Map,i=t.map((e,t)=>{if(e instanceof l){let n=s.get(e);if(void 0!==n)return r++,[`bind___${n}`,e];s.set(e,t-r)}return["bind___"+(n+t-r),e]});for(let[e,t]of i)this._bindings[e]=F(t,{replacer:Te.encode,partial:!0});let a=e.flatMap((e,t)=>{let n=i[t]?.[0];return[e,...n?[`$${n}`]:[]]}).join("");Ie??=new TextEncoder;let o=new Uint8Array(this._query),c=Ie.encode(a);return this._query=new Uint8Array(o.byteLength+c.byteLength),this._query.set(o),this._query.set(c,o.byteLength),this}};function Je(e){let t={},n=(n,r,s)=>{if(n in e)t[r]=`${e[n]}`,delete t[n];else if(!0!==s)throw new f(`Key ${n} is missing from the authentication parameters`)};return"scope"in e?(t={...e},n("scope","sc"),n("namespace","ns"),n("database","db")):"variables"in e?(t={...e.variables},n("access","ac"),n("namespace","ns"),n("database","db")):(n("access","ac",!0),n("database","db",!0),n("namespace","ns",!("database"in e)),n("username","user"),n("password","pass")),t}var Fe=["CREATE","UPDATE","DELETE"];var Pe={enabled:!0,attempts:5,retryDelay:1e3,retryDelayMax:6e4,retryDelayMultiplier:2,retryDelayJitter:.1},Ve="1.4.2",ze="3.0.0";function Ge(e,t=Ve,n=ze){if(!function(e,t=Ve,n=ze){return t.localeCompare(e,void 0,{numeric:!0})<=0&&1===n.localeCompare(e,void 0,{numeric:!0})}(e,t,n))throw new $(e,`>= ${t} < ${n}`);return!0}async function Ke(e,t){let n={"ws:":"http:","wss:":"https:","http:":"http:","https:":"https:"}[e.protocol];if(n){let r=e.pathname.slice(0,-4);(e=new URL(e)).pathname=`${r}/version`,e.protocol=n;let s=new AbortController,i=setTimeout(()=>s.abort(),t??5e3),a="surrealdb-";return await fetch(e,{signal:s.signal}).then(e=>e.text()).then(e=>e.slice(a.length)).catch(e=>{throw new M(e)}).finally(()=>{clearTimeout(i)})}throw new M}var Ye=0;function He(){return(Ye=(Ye+1)%Number.MAX_SAFE_INTEGER).toString()}var Xe,Qe=Symbol("RetryMessage"),Ze=((Xe=Ze||{}).Disconnected="disconnected",Xe.Connecting="connecting",Xe.Reconnecting="reconnecting",Xe.Connected="connected",Xe.Error="error",Xe),et=class{emitter;encodeCbor;decodeCbor;reconnect;prepare;constructor({emitter:e,encodeCbor:t,decodeCbor:n,reconnect:r,prepare:s}){this.emitter=e,this.encodeCbor=t,this.decodeCbor=n,this.reconnect=r,this.prepare=s}},tt=class{context;ready;status="disconnected";connection={url:void 0,namespace:void 0,database:void 0,token:void 0};constructor(e){this.context=e}get emitter(){return this.context.emitter}get encodeCbor(){return this.context.encodeCbor}get decodeCbor(){return this.context.decodeCbor}};function nt(e,t){if("scope"in e||"access"in e&&"variables"in e&&e.variables){if(!e.namespace){if(!t?.namespace)throw new U;e.namespace=t.namespace}if(!e.database){if(!t?.database)throw new E;e.database=t.database}}return e}var rt=class{async signup(e){if(!this.connection)throw new w;let t=Je(nt(e,this.connection.connection)),n=await this.rpc("signup",[t]);if(n.error)throw new A(n.error.message);if(!n.result)throw new N;return n.result}async signin(e){if(!this.connection)throw new w;let t=Je(nt(e,this.connection.connection)),n=await this.rpc("signin",[t]);if(n.error)throw new A(n.error.message);if(!n.result)throw new N;return n.result}async authenticate(e){let t=await this.rpc("authenticate",[e]);if(t.error)throw new A(t.error.message);return!0}async invalidate(){let e=await this.rpc("invalidate");if(e.error)throw new A(e.error.message);return!0}},st=class extends rt{constructor(e){super(),this.connection=e}rpc(e,t){if(!this.connection)throw new w;return this.connection.rpc({method:e,params:t},!0)}},it=class extends tt{async req_post(e,t,n){let r={"Content-Type":"application/cbor",Accept:"application/cbor",...n};this.connection.namespace&&(r["Surreal-NS"]=this.connection.namespace),this.connection.database&&(r["Surreal-DB"]=this.connection.database),this.connection.token&&(r.Authorization=`Bearer ${this.connection.token}`);let s=await fetch(`${t??this.connection.url}`,{method:"POST",headers:r,body:this.encodeCbor(e)}),i=await s.arrayBuffer();if(200===s.status)return i;let a=new TextDecoder("utf-8");throw new x(a.decode(i),s.status,s.statusText,i)}},at=new Set(["signin","signup","authenticate","invalidate","version","use","let","unset","query"]),ot=class extends it{connection={url:void 0,namespace:void 0,database:void 0,token:void 0,variables:{}};setStatus(e,...t){this.status=e,this.emitter.emit(e,t)}version(e,t){return Ke(e,t)}async connect(e){return this.setStatus("connecting"),this.connection.url=e,await(this.context.prepare?.(new st(this))),this.setStatus("connected"),this.ready=new Promise(e=>e()),this.ready}disconnect(){return this.connection={url:void 0,namespace:void 0,database:void 0,token:void 0,variables:{}},this.ready=void 0,this.setStatus("disconnected"),new Promise(e=>e())}async rpc(e,t){if(t||await this.ready,!this.connection.url)throw new k;if(!(this.connection.namespace&&this.connection.database||at.has(e.method)))throw new S;if("use"===e.method){let[t,n]=e.params;return null===t&&(this.connection.namespace=void 0),null===n&&(this.connection.database=void 0),t&&(this.connection.namespace=t),n&&(this.connection.database=n),{result:!0}}if("let"===e.method){let[t,n]=e.params;return this.connection.variables[t]=n,{result:!0}}if("unset"===e.method){let[t]=e.params;return delete this.connection.variables[t],{result:!0}}"query"===e.method&&(e.params=[e.params?.[0],{...this.connection.variables,...e.params?.[1]??{}}]);let n=He(),r=await this.req_post({id:n,...e}),s=this.decodeCbor(r);if("result"in s)switch(e.method){case"signin":case"signup":this.connection.token=s.result;break;case"authenticate":{let[t]=e.params;this.connection.token=t;break}case"invalidate":this.connection.token=void 0}return this.emitter.emit(`rpc-${n}`,[s]),s}get connected(){return!!this.connection.url}async export(e){if(!this.connection.url)throw new k;let t=new URL(this.connection.url),n=t.pathname.slice(0,-4);t.pathname=`${n}/export`;let r=await this.req_post(e??{},t,{Accept:"plain/text"});return new TextDecoder("utf-8").decode(r)}async import(e){if(!this.connection.url)throw new k;let t=new URL(this.connection.url),n=t.pathname.slice(0,-4);t.pathname=`${n}/import`,await this.req_post(e,t,{Accept:"application/json"})}};function ct(){let e={completed:!1};return e.promise=new Promise((t,n)=>{e.resolve=n=>{e.completed=!0,t(n)},e.reject=t=>{e.completed=!0,n(t)}}),e}var lt=class extends it{pinger;socket;disconnected;constructor(e){super(e),this.disconnected=ct()}setStatus(e,...t){this.connection.url&&"disconnected"===e||"error"===e?(this.disconnected.resolve(),this.disconnected=ct()):(this.status=e,this.emitter.emit(e,t))}async requireStatus(e){return this.status!==e&&await this.emitter.subscribeOnce(e),!0}version(e,t){return Ke(e,t)}async connect(e){this.connection.url=e,(async()=>{let e,t=!0;for(;this.connection.url;)if(t)t=!1,this.setStatus("connecting"),this.ready=this.createSocket(),await this.disconnected.promise;else{if(!this.context.reconnect.enabled)break;if(!e){let{promise:t,resolve:n,reject:r}=ct();this.ready=t,e=[n,r]}let[t,n]=e;if(!this.context.reconnect.allowed){this.connection={url:void 0,namespace:void 0,database:void 0,token:void 0},this.socket=void 0,n(new m),this.emitter.emit("error",[new m]),this.setStatus("disconnected");break}this.setStatus("reconnecting"),await this.context.reconnect.iterate();try{await this.createSocket()}catch{continue}try{if(this.connection.namespace||this.connection.database){let e=await this.rpc({method:"use",params:[this.connection.namespace,this.connection.database]},!0);if(e.error)throw new A(e.error.message)}if(this.connection.token){let e=await this.rpc({method:"authenticate",params:[this.connection.token]},!0);if(e.error)throw new A(e.error.message)}}catch(e){this.connection={url:void 0,namespace:void 0,database:void 0,token:void 0},this.socket=void 0,n(e),this.emitter.emit("error",[e]),this.setStatus("disconnected");break}this.context.reconnect.reset(),t(),this.emitter.scanListeners(e=>e.startsWith("rpc-")).map(e=>this.emitter.emit(e,[Qe])),"connected"===this.status&&await this.disconnected.promise}})(),await this.ready}async createSocket(){let{promise:e,resolve:t,reject:n}=ct();if(!this.connection.url)throw new p;let r=new a(this.connection.url.toString(),"cbor");r.addEventListener("open",async()=>{this.socket=r,await(this.context.prepare?.(new st(this))),this.setStatus("connected"),this.pinger?.stop(),this.pinger=new ht(3e4),this.pinger.start(()=>{try{this.rpc({method:"ping"})}catch{}}),t()}),r.addEventListener("error",e=>{let t=new v("detail"in e&&e.detail?e.detail:"message"in e&&e.message?e.message:"error"in e&&e.error?e.error:"An unexpected error occurred");this.setStatus("error",t),n(t)}),r.addEventListener("close",()=>{this.setStatus("disconnected"),this.pinger?.stop()}),r.addEventListener("message",async({data:e})=>{try{let t=this.decodeCbor(e instanceof ArrayBuffer?e:e instanceof Blob?await e.arrayBuffer():e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength));if("object"!=typeof t||null==t||Object.getPrototypeOf(t)!==Object.prototype)throw new b(t);this.handleRpcResponse(t)}catch(e){r.dispatchEvent(new CustomEvent("error",{detail:e}))}}),await e}async disconnect(){this.connection={url:void 0,namespace:void 0,database:void 0,token:void 0},await(this.ready?.catch(()=>{})),this.socket?.close(),this.ready=void 0,this.socket=void 0,this.disconnected.resolve(),await Promise.any([this.requireStatus("disconnected"),this.requireStatus("error")])}async rpc(e,t){if(t||await this.ready,!this.socket)throw new k;let n;for(;!n;){let r=He(),s=this.emitter.subscribeOnce(`rpc-${r}`);if(this.socket.send(this.encodeCbor({id:r,...e})),t&&this.socket.readyState===a.CLOSED)throw new g;let[i]=await s;if(i instanceof g)throw i;i!==Qe&&(n=i)}if("result"in n)switch(e.method){case"use":{let[t,n]=e.params;null===t&&(this.connection.namespace=void 0),null===n&&(this.connection.database=void 0),t&&(this.connection.namespace=t),n&&(this.connection.database=n);break}case"signin":case"signup":this.connection.token=n.result;break;case"authenticate":{let[t]=e.params;this.connection.token=t;break}case"invalidate":this.connection.token=void 0}return n}handleRpcResponse({id:e,...t}){if(e)this.emitter.emit(`rpc-${e}`,[t]);else if(t.error)this.setStatus("error",new A(t.error));else if("object"==typeof(n=t.result)&&null!==n&&"id"in n&&"action"in n&&"result"in n&&n.id instanceof be&&Fe.includes(n.action)&&"object"==typeof n.result&&null!==n.result){let{id:e,action:n,result:r}=t.result;this.emitter.emit(`live-${e}`,[n,r],!0)}else this.setStatus("error",new b({id:e,...t}));var n}get connected(){return!!this.socket}async export(e){if(!this.connection.url)throw new k;let t=new URL(this.connection.url),n=t.pathname.slice(0,-4);t.protocol=t.protocol.replace("ws","http"),t.pathname=`${n}/export`;let r=await this.req_post(e??{},t,{Accept:"plain/text"});return new TextDecoder("utf-8").decode(r)}async import(e){if(!this.connection.url)throw new k;let t=new URL(this.connection.url),n=t.pathname.slice(0,-4);t.protocol=t.protocol.replace("ws","http"),t.pathname=`${n}/import`,await this.req_post(e,t,{Accept:"application/json"})}},ht=class{pinger;interval;constructor(e=3e4){this.interval=e}start(e){this.pinger=setInterval(e,this.interval)}stop(){clearInterval(this.pinger)}};var ut=class{_attempts=0;options;surreal;constructor(e,t){this.surreal=t,this.options=e?!0===e?Pe:{...Pe,...e}:{...Pe,enabled:!1}}get attempts(){return this._attempts}get enabled(){return this.options.enabled}get allowed(){return!(!this.options.enabled||-1!==this.options.attempts&&this._attempts>=this.options.attempts)}reset(){this._attempts=0}async iterate(){if(!this.allowed)throw new y;this._attempts++;let e=this.options.retryDelayMultiplier**this.attempts,t=this.options.retryDelay*e,n=(s=-this.options.retryDelayJitter,i=this.options.retryDelayJitter,Math.random()*(i-s)+s),r=Math.min(t*(1+n),this.options.retryDelayMax);var s,i;await new Promise(e=>setTimeout(e,r))}},dt=class extends rt{connection;emitter;engines={ws:lt,wss:lt,http:ot,https:ot};_ready;constructor({engines:e}={}){super(),this.emitter=new c,e&&(this.engines={...this.engines,...e})}async connect(e,t={}){return this._ready=this.connectInner(e,t),await this._ready,!0}async connectInner(e,t={}){let n=function(e){let t=new URL(e);return t.pathname.endsWith("/rpc")||(t.pathname.endsWith("/")||(t.pathname+="/"),t.pathname+="rpc"),t}(e),r=n.protocol.slice(0,-1),s=this.engines[r];if(!s)throw new _(r);let{prepare:i,auth:a,namespace:o,database:c,reconnect:l}=t;await this.close();let h=new s(new et({emitter:this.emitter,encodeCbor:We,decodeCbor:qe,reconnect:new ut(l,this),prepare:i}));if(!1!==t.versionCheck){Ge(await h.version(n,t.versionCheckTimeout))}this.connection=h,await h.connect(n),(o||c)&&await this.use({namespace:o,database:c}),"string"==typeof a?await this.authenticate(a):a&&await this.signin(a)}async close(){return this.clean(),await(this.connection?.disconnect()),!0}clean(){let e=this.emitter.scanListeners(e=>e.startsWith("rpc-"));e.map(e=>this.emitter.emit(e,[new g]));let t=this.emitter.scanListeners(e=>e.startsWith("live-"));t.map(e=>this.emitter.emit(e,["CLOSE","disconnected"])),this.emitter.reset({collectable:!0,listeners:[...e,...t]})}get status(){return this.connection?.status??"disconnected"}get ready(){return Promise.all([this._ready,this.connection?.ready]).then(()=>{})}async ping(){let{error:e}=await this.rpc("ping");if(e)throw new A(e.message);return!0}async use({namespace:e,database:t}){if(!this.connection)throw new w;if(null===e&&null!==t)throw new f("Cannot unset namespace without unsetting database");let{error:n}=await this.rpc("use",[e,t]);if(n)throw new A(n.message);return!0}async info(){await this.ready;let e=await this.rpc("info");if(e.error)throw new A(e.error.message);return e.result??void 0}async let(e,t){let n=await this.rpc("let",[e,t]);if(n.error)throw new A(n.error.message);return!0}async unset(e){let t=await this.rpc("unset",[e]);if(t.error)throw new A(t.error.message);return!0}async live(e,t,n){await this.ready;let r=await this.rpc("live",[e,n]);if(r.error)throw new A(r.error.message);return t&&this.subscribeLive(r.result,t),r.result}async subscribeLive(e,t){if(await this.ready,!this.connection)throw new w;this.connection.emitter.subscribe(`live-${e}`,t,!0)}async unSubscribeLive(e,t){if(await this.ready,!this.connection)throw new w;this.connection.emitter.unSubscribe(`live-${e}`,t)}async kill(e){if(await this.ready,!this.connection)throw new w;if(Array.isArray(e)){await Promise.all(e.map(e=>this.rpc("kill",[e])));let t=e.map(e=>`live-${e}`);t.map(e=>this.emitter.emit(e,["CLOSE","killed"])),this.connection.emitter.reset({collectable:t,listeners:t})}else await this.rpc("kill",[e]),this.emitter.emit(`live-${e}`,["CLOSE","killed"]),this.connection.emitter.reset({collectable:`live-${e}`,listeners:`live-${e}`})}async query(...e){return(await this.queryRaw(...e)).map(({status:e,result:t})=>{if("ERR"===e)throw new A(t);return t})}async queryRaw(...[e,t]){let n=e instanceof Be?[e.query,I(e.bindings,{fills:t,replacer:Te.encode})]:[e,t];await this.ready;let r=await this.rpc("query",n);if(r.error)throw new A(r.error.message);return r.result}async query_raw(...e){return this.queryRaw(...e)}async select(e){await this.ready;let t=await this.rpc("select",[e]);if(t.error)throw new A(t.error.message);return ft(e,t.result)}async create(e,t){await this.ready;let n=await this.rpc("create",[e,t]);if(n.error)throw new A(n.error.message);return ft(e,n.result)}async insert(e,t){await this.ready;let[n,r]="string"==typeof e||e instanceof xe?[e,t]:[void 0,e],s=await this.rpc("insert",[n,r]);if(s.error)throw new A(s.error.message);return s.result}async insertRelation(e,t){await this.ready;let[n,r]="string"==typeof e||e instanceof xe?[e,t]:[void 0,e],s=await this.rpc("insert_relation",[n,r]);if(s.error)throw new A(s.error.message);return s.result}async insert_relation(e,t){return e instanceof xe||"string"==typeof e?this.insertRelation(e,t):this.insertRelation(e)}async update(e,t){await this.ready;let n=await this.rpc("update",[e,t]);if(n.error)throw new A(n.error.message);return ft(e,n.result)}async upsert(e,t){await this.ready;let n=await this.rpc("upsert",[e,t]);if(n.error)throw new A(n.error.message);return ft(e,n.result)}async merge(e,t){await this.ready;let n=await this.rpc("merge",[e,t]);if(n.error)throw new A(n.error.message);return ft(e,n.result)}async patch(e,t,n){await this.ready;let r=await this.rpc("patch",[e,t,n]);if(r.error)throw new A(r.error.message);return n?r.result:ft(e,r.result)}async delete(e){await this.ready;let t=await this.rpc("delete",[e]);if(t.error)throw new A(t.error.message);return ft(e,t.result)}async version(){await this.ready;let e=await this.rpc("version");if(e.error)throw new A(e.error.message);return e.result}async run(e,t,n){await this.ready;let[r,s]=Array.isArray(t)?[void 0,t]:[t,n],i=await this.rpc("run",[e,r,s]);if(i.error)throw new A(i.error.message);return i.result}async relate(e,t,n,r){await this.ready;let s=await this.rpc("relate",[e,t,n,r]);if(s.error)throw new A(s.error.message);return ft(t,s.result)}rpc(e,t){if(!this.connection)throw new w;return this.connection.rpc({method:e,params:t})}async export(e){if(await this.ready,!this.connection)throw new w;return this.connection.export(e)}async import(e){if(await this.ready,!this.connection)throw new w;return this.connection.import(e)}};function ft(e,t){return e instanceof ve||e instanceof _e?Array.isArray(t)?t[0]:t:Array.isArray(t)?t:[t]}let wt=null,pt=!1,gt=!1,mt=null;const yt={},bt=new Map;let vt=null;function _t(e,t){null===t?delete yt[e]:yt[e]=t}function kt(e){return yt[e]??null}async function St(e,t){const n=await self.clients.get(e);n?n.postMessage(t):console.warn(`ServiceWorker: Client with ID ${e} not found.`)}async function xt(e,t){for(const n of t)await St(n,e)}function At(){return!!kt("tenant_code")||(_t("access_token",null),_t("refresh_token",null),_t("token_expires_at",null),Ut({type:"tenant_code_missing",payload:{message:"Tenant code is missing, user needs to login again"}}),!1)}async function Ut(e){const t=await self.clients.matchAll();for(const n of t)n.postMessage(e)}async function Et(){try{const e=kt("refresh_token");if(!e)return console.error("ServiceWorker: No refresh token available"),!1;const t=(void 0).VITE_API_URL||"http://localhost:8082",n=await fetch(`${t}/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:e})}),r=await n.json();if(501===n.status)return console.warn("ServiceWorker: Token refresh not yet implemented on backend:",r.message),Nt(),!1;if(!n.ok)throw new Error("Failed to refresh token");if(r.access_token){if(_t("access_token",r.access_token),r.refresh_token&&_t("refresh_token",r.refresh_token),r.expires_in){_t("token_expires_at",(Date.now()+1e3*r.expires_in).toString())}return pt&&wt&&await wt.authenticate(r.access_token),console.log("ServiceWorker: Access token refreshed successfully"),Ut({type:"token_refreshed",payload:{success:!0}}),!0}return!1}catch(e){return console.error("ServiceWorker: Error refreshing access token:",e),!1}}function Nt(){_t("access_token",null),_t("refresh_token",null),_t("token_expires_at",null),Ut({type:"auth_state_cleared",payload:{message:"Authentication state cleared due to token refresh failure"}})}async function $t(){if(!At())return console.log("ServiceWorker: Tenant code missing, user needs to login again"),void Nt();const e=kt("token_expires_at");if(!e)return;const t=parseInt(e,10)-Date.now();if(t<=6e5&&t>0){console.log("ServiceWorker: Token expiring soon, attempting refresh...");await Et()||(console.error("ServiceWorker: Failed to refresh token, clearing auth state"),Nt())}}function Mt(){vt&&(clearInterval(vt),vt=null),vt=setInterval($t,3e5),setTimeout($t,1e3),console.log("ServiceWorker: Token refresh timer set up")}function Ct(){vt&&(clearInterval(vt),vt=null,console.log("ServiceWorker: Token refresh timer cleared"))}async function Rt(e){if(await async function(){if(!gt||wt?.connection?.status!==Ze.Connected)try{wt=new dt,gt=!0,console.log("ServiceWorker: SurrealDB initialized successfully")}catch(e){throw console.error("ServiceWorker: Failed to initialize SurrealDB:",e),e}}(),e&&mt){const t=mt.endpoint!==e.endpoint,n=mt.namespace!==e.namespace,r=mt.database!==e.database,s=JSON.stringify(mt.auth)!==JSON.stringify(e.auth);if(t){if(console.log("ServiceWorker: Endpoint changed, reconnecting...",mt.endpoint,"->",e.endpoint),pt&&wt)try{await wt.close()}catch(e){console.warn("ServiceWorker: Error closing connection:",e)}pt=!1,mt=e}else if(n||r){if(console.log("ServiceWorker: Namespace/Database changed, switching...",{namespace:mt.namespace,database:mt.database},"->",{namespace:e.namespace,database:e.database}),pt&&wt)try{await wt.use({namespace:e.namespace,database:e.database});const t=kt("access_token");t&&(await wt.authenticate(t),console.log("ServiceWorker: Re-authenticated after namespace/database change."))}catch(e){console.error("ServiceWorker: Failed to switch namespace/database:",e),pt=!1}mt=e}else if(s){if(console.log("ServiceWorker: Auth changed, re-authenticating..."),pt&&wt)try{const e=kt("access_token");e&&(await wt.authenticate(e),console.log("ServiceWorker: Re-authenticated with new auth info."))}catch(e){console.error("ServiceWorker: Re-authentication failed:",e)}mt=e}else mt=e}else e&&(mt=e);if(!mt)return console.error("ServiceWorker: Connection config not set."),!1;if(!pt)try{console.log(`ServiceWorker: Connecting to ${mt.endpoint}...`),await wt.connect(mt.endpoint),await wt.use({namespace:mt.namespace,database:mt.database});const e=kt("access_token");if(e)try{await wt.authenticate(e),console.log("ServiceWorker: Re-authenticated successfully with stored token.");const t=kt("refresh_token"),n=kt("token_expires_at");t&&n&&Mt()}catch(e){console.warn("ServiceWorker: Stored token authentication failed.",e),_t("access_token",null),_t("refresh_token",null),_t("token_expires_at",null),Ct()}pt=!0,console.log("ServiceWorker: Connection established."),await async function(){console.log("ServiceWorker: Resubscribing to all live queries...");for(const[e,t]of bt.entries())try{if(!wt)throw new Error("Database not initialized");await wt.live(t.query,(n,r)=>{xt({type:"live_update",payload:{uuid:e,action:n,result:r}},t.clients)}),console.log(`ServiceWorker: Successfully resubscribed to live query ${e}`)}catch(t){console.error(`ServiceWorker: Failed to resubscribe to live query ${e}`,t)}}()}catch(e){return console.error("ServiceWorker: Connection failed.",e),pt=!1,!1}return!0}self.addEventListener("install",e=>{console.log("Service Worker installing"),e.waitUntil(self.skipWaiting())}),self.addEventListener("activate",e=>{console.log("Service Worker activating"),e.waitUntil(self.clients.claim())}),self.addEventListener("beforeunload",()=>{Ct()}),self.addEventListener("message",async e=>{if(!e.data||!e.data.type)return;const{type:t,payload:n,messageId:r}=e.data,s=e.source?.id;if(!s)return;const i=e=>St(s,{type:`${t}_response`,messageId:r,payload:e}),a=e=>St(s,{type:`${t}_error`,messageId:r,payload:{message:e.message,stack:e.stack}});try{switch(t){case"connect":n.sync_tokens&&(n.sync_tokens.access_token&&_t("access_token",n.sync_tokens.access_token),n.sync_tokens.refresh_token&&_t("refresh_token",n.sync_tokens.refresh_token),n.sync_tokens.token_expires_at&&_t("token_expires_at",n.sync_tokens.token_expires_at),n.sync_tokens.tenant_code&&_t("tenant_code",n.sync_tokens.tenant_code)),await Rt(n),i({status:pt?"connected":"disconnected"});break;case"authenticate":if(_t("access_token",n.token),n.refresh_token&&_t("refresh_token",n.refresh_token),n.expires_in){_t("token_expires_at",(Date.now()+1e3*n.expires_in).toString())}if(n.tenant_code&&_t("tenant_code",n.tenant_code),await Rt(),!pt)throw new Error("Connection not established.");await wt.authenticate(n.token),Mt(),i({success:!0});break;case"invalidate":_t("access_token",null),_t("refresh_token",null),_t("token_expires_at",null),Ct(),pt&&await wt.invalidate(),i({success:!0});break;case"query":case"mutate":{if(await Rt(),!wt)throw new Error("Database not initialized");const[e]=await wt.query(n.sql,n.vars);i(e);break}case"create":if(await Rt(),!wt)throw new Error("Database not initialized");i(await wt.create(n.thing,n.data));break;case"select":if(await Rt(),!wt)throw new Error("Database not initialized");i(await wt.select(n.thing));break;case"update":if(await Rt(),!wt)throw new Error("Database not initialized");i(await wt.update(n.thing,n.data));break;case"merge":if(await Rt(),!wt)throw new Error("Database not initialized");i(await wt.merge(n.thing,n.data));break;case"delete":if(await Rt(),!wt)throw new Error("Database not initialized");i(await wt.delete(n.thing));break;case"live":{if(await Rt(),!wt)throw new Error("Database not initialized");const{query:e,vars:t}=n,r=e,a=await wt.live(r,(e,t)=>{const n=bt.get(String(a));n&&xt({type:"live_update",payload:{uuid:String(a),action:e,result:t}},n.clients)}),o=String(a);bt.has(o)||bt.set(o,{query:e,vars:t,clients:new Set}),bt.get(o).clients.add(s),i({uuid:o});break}case"kill":{const{uuid:e}=n,t=bt.get(e);t&&(t.clients.delete(s),0===t.clients.size&&wt&&(await wt.kill(e),bt.delete(e),console.log(`ServiceWorker: Killed live query ${e} as no clients are listening.`))),i({success:!0});break}case"setup_token_refresh":Mt(),i({success:!0});break;case"clear_token_refresh":Ct(),i({success:!0});break;case"refresh_token":i({success:await Et()});break;case"check_tenant_code":i({valid:At()});break;default:console.warn(`ServiceWorker: Unknown message type received: ${t}`),a(new Error(`Unknown message type: ${t}`))}}catch(e){console.error(`ServiceWorker: Error processing message type ${t}:`,e),a(e)}}),console.log("Service Worker loaded")}();
