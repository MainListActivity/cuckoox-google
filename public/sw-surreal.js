!function(){"use strict";
/**
     * uuidv7: A JavaScript implementation of UUID version 7
     *
     * Copyright 2021-2024 LiosK
     *
     * @license Apache-2.0
     * @packageDocumentation
     */const e="0123456789abcdef";class t{constructor(e){this.bytes=e}static ofInner(e){if(16!==e.length)throw new TypeError("not 128-bit length");return new t(e)}static fromFieldsV7(e,r,n,i){if(!Number.isInteger(e)||!Number.isInteger(r)||!Number.isInteger(n)||!Number.isInteger(i)||e<0||r<0||n<0||i<0||e>0xffffffffffff||r>4095||n>1073741823||i>4294967295)throw new RangeError("invalid field value");const s=new Uint8Array(16);return s[0]=e/2**40,s[1]=e/2**32,s[2]=e/2**24,s[3]=e/65536,s[4]=e/256,s[5]=e,s[6]=112|r>>>8,s[7]=r,s[8]=128|n>>>24,s[9]=n>>>16,s[10]=n>>>8,s[11]=n,s[12]=i>>>24,s[13]=i>>>16,s[14]=i>>>8,s[15]=i,new t(s)}static parse(e){var r,n,i,s;let a;switch(e.length){case 32:a=null===(r=/^[0-9a-f]{32}$/i.exec(e))||void 0===r?void 0:r[0];break;case 36:a=null===(n=/^([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})$/i.exec(e))||void 0===n?void 0:n.slice(1,6).join("");break;case 38:a=null===(i=/^\{([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})\}$/i.exec(e))||void 0===i?void 0:i.slice(1,6).join("");break;case 45:a=null===(s=/^urn:uuid:([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})$/i.exec(e))||void 0===s?void 0:s.slice(1,6).join("")}if(a){const e=new Uint8Array(16);for(let t=0;t<16;t+=4){const r=parseInt(a.substring(2*t,2*t+8),16);e[t+0]=r>>>24,e[t+1]=r>>>16,e[t+2]=r>>>8,e[t+3]=r}return new t(e)}throw new SyntaxError("could not parse UUID string")}toString(){let t="";for(let r=0;r<this.bytes.length;r++)t+=e.charAt(this.bytes[r]>>>4),t+=e.charAt(15&this.bytes[r]),3!==r&&5!==r&&7!==r&&9!==r||(t+="-");return t}toHex(){let t="";for(let r=0;r<this.bytes.length;r++)t+=e.charAt(this.bytes[r]>>>4),t+=e.charAt(15&this.bytes[r]);return t}toJSON(){return this.toString()}getVariant(){const e=this.bytes[8]>>>4;if(e<0)throw new Error("unreachable");if(e<=7)return this.bytes.every(e=>0===e)?"NIL":"VAR_0";if(e<=11)return"VAR_10";if(e<=13)return"VAR_110";if(e<=15)return this.bytes.every(e=>255===e)?"MAX":"VAR_RESERVED";throw new Error("unreachable")}getVersion(){return"VAR_10"===this.getVariant()?this.bytes[6]>>>4:void 0}clone(){return new t(this.bytes.slice(0))}equals(e){return 0===this.compareTo(e)}compareTo(e){for(let t=0;t<16;t++){const r=this.bytes[t]-e.bytes[t];if(0!==r)return Math.sign(r)}return 0}}class r{constructor(e){this.timestamp=0,this.counter=0,this.random=null!=e?e:n()}generate(){return this.generateOrResetCore(Date.now(),1e4)}generateOrAbort(){return this.generateOrAbortCore(Date.now(),1e4)}generateOrResetCore(e,t){let r=this.generateOrAbortCore(e,t);return void 0===r&&(this.timestamp=0,r=this.generateOrAbortCore(e,t)),r}generateOrAbortCore(e,r){if(!Number.isInteger(e)||e<1||e>0xffffffffffff)throw new RangeError("`unixTsMs` must be a 48-bit positive integer");if(r<0||r>0xffffffffffff)throw new RangeError("`rollbackAllowance` out of reasonable range");if(e>this.timestamp)this.timestamp=e,this.resetCounter();else{if(!(e+r>=this.timestamp))return;this.counter++,this.counter>4398046511103&&(this.timestamp++,this.resetCounter())}return t.fromFieldsV7(this.timestamp,Math.trunc(this.counter/2**30),this.counter&2**30-1,this.random.nextUint32())}resetCounter(){this.counter=1024*this.random.nextUint32()+(1023&this.random.nextUint32())}generateV4(){const e=new Uint8Array(Uint32Array.of(this.random.nextUint32(),this.random.nextUint32(),this.random.nextUint32(),this.random.nextUint32()).buffer);return e[6]=64|e[6]>>>4,e[8]=128|e[8]>>>2,t.ofInner(e)}}const n=()=>{if("undefined"!=typeof crypto&&void 0!==crypto.getRandomValues)return new i;if("undefined"!=typeof UUIDV7_DENY_WEAK_RNG&&UUIDV7_DENY_WEAK_RNG)throw new Error("no cryptographically strong RNG available");return{nextUint32:()=>65536*Math.trunc(65536*Math.random())+Math.trunc(65536*Math.random())}};class i{constructor(){this.buffer=new Uint32Array(8),this.cursor=65535}nextUint32(){return this.cursor>=this.buffer.length&&(crypto.getRandomValues(this.buffer),this.cursor=0),this.buffer[this.cursor++]}}let s;const a=function(){if("undefined"!=typeof WebSocket)return WebSocket;if(void 0!==global.WebSocket)return global.WebSocket;if(void 0!==window.WebSocket)return window.WebSocket;if(void 0!==self.WebSocket)return self.WebSocket;throw new Error("`WebSocket` is not supported in this environment")}();var o=Object.defineProperty,c=class{collectable={};listeners={};interceptors;constructor({interceptors:e}={}){this.interceptors=e??{}}subscribe(e,t,r=!1){if(this.listeners[e]||(this.listeners[e]=[]),!this.isSubscribed(e,t)&&(this.listeners[e]?.push(t),r&&this.collectable[e])){let r=this.collectable[e];delete this.collectable[e];for(let e of r)t(...e)}}async subscribeOnce(e,t=!1){if(t&&this.collectable[e]){let t=this.collectable[e]?.shift();if(0===this.collectable[e]?.length&&delete this.collectable[e],t)return t}return new Promise(t=>{let r=!1,n=(...i)=>{r||(r=!0,this.unSubscribe(e,n),t(i))};this.subscribe(e,n,!1)})}unSubscribe(e,t){if(this.listeners[e]){let r=this.listeners[e]?.findIndex(e=>e===t);r>=0&&(this.listeners[e]?.splice(r,1),0===this.listeners[e]?.length&&delete this.listeners[e])}}isSubscribed(e,t){return!!this.listeners[e]?.includes(t)}async emit(e,t,r=!1){let n=this.interceptors[e],i=n?await n(...t):t;(r&&!this.listeners[e]||0===this.listeners[e]?.length)&&(this.collectable[e]||(this.collectable[e]=[]),this.collectable[e]?.push(t));for(let t of this.listeners[e]??[])t(...i)}reset({collectable:e,listeners:t}){if(Array.isArray(e))for(let t of e)delete this.collectable[t];else"string"==typeof e?delete this.collectable[e]:!1!==e&&(this.collectable={});if(Array.isArray(t))for(let e of t)delete this.listeners[e];else"string"==typeof t?delete this.listeners[t]:!1!==t&&(this.listeners={})}scanListeners(e){let t=Object.keys(this.listeners);return e&&(t=t.filter(e)),t}},l=class{args=[];constructor(...e){this.args=e}fill(e){return[this,e]}hasDefault(){return 1===this.args.length}get default(){return this.args[0]}};((e,t)=>{for(var r in t)o(e,r,{get:t[r],enumerable:!0})})({},{CborBreak:()=>j,CborError:()=>N,CborFillMissing:()=>L,CborInvalidMajorError:()=>C,CborNumberError:()=>D,CborPartialDisabled:()=>R,CborRangeError:()=>O,Encoded:()=>d,Gap:()=>l,POW_2_53:()=>h,POW_2_64:()=>u,PartiallyEncoded:()=>q,Reader:()=>V,Tagged:()=>F,Writer:()=>I,decode:()=>G,encode:()=>P,infiniteBytes:()=>z,partiallyEncodeObject:()=>B});var h=9007199254740992,u=BigInt(0x10000000000000000),d=class{constructor(e){this.encoded=e}},f=class extends Error{},w=class extends f{name="NoActiveSocket";message="No socket is currently connected to a SurrealDB instance. Please call the .connect() method first!"},p=class extends f{name="NoURLProvided";message="Tried to establish a connection while no connection URL was provided"},g=class extends f{name="EngineDisconnected";message="The engine reported the connection to SurrealDB has dropped"},y=class extends f{name="ReconnectFailed";message="The engine failed to reconnect to SurrealDB"},m=class extends f{name="ReconnectIterationError";message="The reconnect iterator failed to iterate"},b=class extends f{constructor(e){super(),this.response=e,this.message=`${e}`}name="UnexpectedServerResponse"},v=class extends f{constructor(e){super(),this.error=e,this.message=`${e}`}name="UnexpectedConnectionError"},k=class extends f{constructor(e){super(),this.engine=e}name="UnsupportedEngine";message="The engine you are trying to connect to is not supported or configured."},_=class extends f{name="ConnectionUnavailable";message="There is no connection available at this moment."},S=class extends f{name="MissingNamespaceDatabase";message="There is no namespace and/or database selected."},x=class extends f{constructor(e,t,r,n){super(),this.message=e,this.status=t,this.statusText=r,this.buffer=n}name="HttpConnectionError"},A=class extends f{constructor(e){super(),this.message=e}name="ResponseError"},E=class extends f{name="NoNamespaceSpecified";message="Please specify a namespace to use."},U=class extends f{name="NoDatabaseSpecified";message="Please specify a database to use."},M=class extends f{name="NoTokenReturned";message="Did not receive an authentication token."},W=class extends f{name="UnsupportedVersion";version;supportedRange;constructor(e,t){super(),this.version=e,this.supportedRange=t,this.message=`The version "${e}" reported by the engine is not supported by this library, expected a version that satisfies "${t}".`}},$=class extends f{constructor(e){super(),this.error=e}name="VersionRetrievalFailure";message="Failed to retrieve remote version. If the server is behind a proxy, make sure it's configured correctly."},N=class extends f{message;constructor(e){super(),this.message=e}},D=class extends N{name="CborNumberError"},O=class extends N{name="CborRangeError"},C=class extends N{name="CborInvalidMajorError"},j=class extends N{name="CborBreak";constructor(){super("Came across a break which was not intercepted by the decoder")}},R=class extends N{name="CborPartialDisabled";constructor(){super("Tried to insert a Gap into a CBOR value, while partial mode is not enabled")}},L=class extends N{name="CborFillMissing";constructor(){super("Fill for a gap is missing, and gap has no default")}},I=class{constructor(e=256){this.byteLength=e,this._buf=new ArrayBuffer(this.byteLength),this._view=new DataView(this._buf),this._byte=new Uint8Array(this._buf)}_chunks=[];_pos=0;_buf;_view;_byte;chunk(e){this._chunks.push([this._buf.slice(0,this._pos),e]),this._buf=new ArrayBuffer(this.byteLength),this._view=new DataView(this._buf),this._byte=new Uint8Array(this._buf),this._pos=0}get chunks(){return this._chunks}get buffer(){return this._buf.slice(0,this._pos)}claim(e){let t=this._pos;if(this._pos+=e,this._pos<=this._buf.byteLength)return t;let r=this._buf.byteLength<<1;for(;r<this._pos;)r<<=1;if(r>this._buf.byteLength){let e=this._byte;this._buf=new ArrayBuffer(r),this._view=new DataView(this._buf),this._byte=new Uint8Array(this._buf),this._byte.set(e)}return t}writeUint8(e){let t=this.claim(1);this._view.setUint8(t,e)}writeUint16(e){let t=this.claim(2);this._view.setUint16(t,e)}writeUint32(e){let t=this.claim(4);this._view.setUint32(t,e)}writeUint64(e){let t=this.claim(8);this._view.setBigUint64(t,e)}writeUint8Array(e){if(0===e.byteLength)return;let t=this.claim(e.byteLength);this._byte.set(e,t)}writeArrayBuffer(e){0!==e.byteLength&&this.writeUint8Array(new Uint8Array(e))}writePartiallyEncoded(e){for(let[t,r]of e.chunks)this.writeArrayBuffer(t),this.chunk(r);this.writeArrayBuffer(e.end)}writeFloat32(e){let t=this.claim(4);this._view.setFloat32(t,e)}writeFloat64(e){let t=this.claim(8);this._view.setFloat64(t,e)}writeMajor(e,t){let r=e<<5;t<24?this.writeUint8(r+Number(t)):t<256?(this.writeUint8(r+24),this.writeUint8(Number(t))):t<65536?(this.writeUint8(r+25),this.writeUint16(Number(t))):t<4294967296?(this.writeUint8(r+26),this.writeUint32(Number(t))):(this.writeUint8(r+27),this.writeUint64(BigInt(t)))}output(e,t){return e?new q(this._chunks,this.buffer,t):this.buffer}},q=class{constructor(e,t,r){this.chunks=e,this.end=t,this.replacer=r}build(e,t){let r=new I,n=new Map(e);for(let[e,i]of this.chunks){let s=n.has(i)||i.hasDefault();if(!t&&!s)throw new L;if(r.writeArrayBuffer(e),s){P(n.get(i)??i.default,{writer:r,replacer:this.replacer})}else r.chunk(i)}return r.writeArrayBuffer(this.end),r.output(!!t,this.replacer)}};function B(e,t){return Object.fromEntries(Object.entries(e).map(([e,r])=>[e,P(r,{...t,partial:!0})]))}var T,F=class{constructor(e,t){this.tag=e,this.value=t}};function P(e,t={}){let r=t.writer??new I,n=new Map(t.fills??[]);return function e(i){let s=t.replacer?t.replacer(i):i;if(void 0===s)return r.writeUint8(247);if(null===s)return r.writeUint8(246);if(!0===s)return r.writeUint8(245);if(!1===s)return r.writeUint8(244);switch(typeof s){case"number":if(Number.isInteger(s))if(s>=0&&s<=9007199254740992)r.writeMajor(0,s);else{if(!(s<0&&s>=-9007199254740992))throw new D("Number too big to be encoded");r.writeMajor(1,-(s+1))}else r.writeUint8(251),r.writeFloat64(s);return;case"bigint":if(s>=0&&s<u)r.writeMajor(0,s);else{if(!(s<=0&&s>=-u))throw new D("BigInt too big to be encoded");r.writeMajor(1,-(s+1n))}return;case"string":{T??=new TextEncoder;let e=T.encode(s);return r.writeMajor(3,e.byteLength),void r.writeUint8Array(e)}default:{if(Array.isArray(s)){r.writeMajor(4,s.length);for(let t of s)e(t);return}if(s instanceof F)return r.writeMajor(6,s.tag),void e(s.value);if(s instanceof d)return void r.writeArrayBuffer(s.encoded);if(s instanceof l){if(n.has(s))e(n.get(s));else{if(!t.partial)throw new R;r.chunk(s)}return}if(s instanceof q){let e=s.build(t.fills??[],t.partial);return void(t.partial?r.writePartiallyEncoded(e):r.writeArrayBuffer(e))}if(s instanceof Uint8Array||s instanceof Uint16Array||s instanceof Uint32Array||s instanceof Int8Array||s instanceof Int16Array||s instanceof Int32Array||s instanceof Float32Array||s instanceof Float64Array||s instanceof ArrayBuffer){let e=new Uint8Array(s);return r.writeMajor(2,e.byteLength),void r.writeUint8Array(e)}let i=s instanceof Map?Array.from(s.entries()):Object.entries(s);r.writeMajor(5,i.length);for(let t of i.flat())e(t)}}}(e),r.output(!!t.partial,t.replacer)}var J,V=class{_buf;_view;_byte;_pos=0;constructor(e){this._buf=new ArrayBuffer(e.byteLength),this._view=new DataView(this._buf),this._byte=new Uint8Array(this._buf),this._byte.set(new Uint8Array(e))}read(e,t){return this._pos+=e,t}readUint8(){try{return this.read(1,this._view.getUint8(this._pos))}catch(e){throw e instanceof RangeError?new O(e.message):e}}readUint16(){try{return this.read(2,this._view.getUint16(this._pos))}catch(e){throw e instanceof RangeError?new O(e.message):e}}readUint32(){try{return this.read(4,this._view.getUint32(this._pos))}catch(e){throw e instanceof RangeError?new O(e.message):e}}readUint64(){try{return this.read(8,this._view.getBigUint64(this._pos))}catch(e){throw e instanceof RangeError?new O(e.message):e}}readFloat16(){let e=this.readUint16(),t=(32768&e)>>15,r=(31744&e)>>10,n=1023&e;return 0===r?(t?-1:1)*2**-14*(n/1024):31===r?n?Number.NaN:(t?-1:1)*Number.POSITIVE_INFINITY:(t?-1:1)*2**(r-15)*(1+n/1024)}readFloat32(){try{return this.read(4,this._view.getFloat32(this._pos))}catch(e){throw e instanceof RangeError?new O(e.message):e}}readFloat64(){try{return this.read(8,this._view.getFloat64(this._pos))}catch(e){throw e instanceof RangeError?new O(e.message):e}}readBytes(e){let t=this._byte.length-this._pos;if(t<e)throw new O(`The argument must be between 0 and ${t}`);return this.read(e,this._byte.slice(this._pos,this._pos+e))}readMajor(){let e=this.readUint8(),t=e>>5;if(t<0||t>7)throw new C("Received invalid major type");return[t,31&e]}readMajorLength(e){if(e<=23)return e;switch(e){case 24:return this.readUint8();case 25:return this.readUint16();case 26:return this.readUint32();case 27:{let e=this.readUint64();return e>9007199254740992?e:Number(e)}}throw new O("Expected a final length")}};function z(e,t){let r=new I;for(;;){let[n,i]=e.readMajor();if(7===n&&31===i)break;if(n!==t)throw new C(`Expected a resource of the same major (${t}) while processing an infinite resource`);if(31===i)throw new O("Expected a finite resource while processing an infinite resource");r.writeUint8Array(e.readBytes(Number(e.readMajorLength(i))))}return r.buffer}function G(e,t={}){let r=e instanceof V?e:new V(e);function n(){let[e,n]=r.readMajor();switch(e){case 0:return r.readMajorLength(n);case 1:{let e=r.readMajorLength(n);return"bigint"==typeof e?-(e+1n):-(e+1)}case 2:return 31===n?z(r,2):r.readBytes(Number(r.readMajorLength(n))).buffer;case 3:{let e=31===n?z(r,3):r.readBytes(Number(r.readMajorLength(n)));return J??=new TextDecoder,J.decode(e)}case 4:{if(31===n){let e=[];for(;;)try{e.push(i())}catch(e){if(e instanceof j)break;throw e}return e}let e=r.readMajorLength(n),t=Array(e);for(let r=0;r<e;r++)t[r]=i();return t}case 5:{let e=[];if(31===n)for(;;){let t;try{t=i()}catch(e){if(e instanceof j)break;throw e}let r=i();e.push([t,r])}else{let t=r.readMajorLength(n);for(let r=0;r<t;r++){let t=i(),n=i();e[r]=[t,n]}}return"map"===t.map?new Map(e):Object.fromEntries(e)}case 6:{let e=r.readMajorLength(n),t=i();return new F(e,t)}case 7:switch(n){case 20:return!1;case 21:return!0;case 22:return null;case 23:return;case 25:return r.readFloat16();case 26:return r.readFloat32();case 27:return r.readFloat64();case 31:throw new j}}throw new C(`Unable to decode value with major tag ${e}`)}function i(){return t.replacer?t.replacer(n()):n()}return i()}var K=class{},Y=class e extends K{decimal;constructor(e){super(),this.decimal=e.toString()}equals(t){return t instanceof e&&this.decimal===t.decimal}toString(){return this.decimal}toJSON(){return this.decimal}},H=.001,X=1e-6,Q=1e3,Z=6e4,ee=36e5,te=24*ee,re=7*te,ne=new Map([["ns",X],["µs",H],["μs",H],["us",H],["ms",1],["s",Q],["m",Z],["h",ee],["d",te],["w",re]]),ie=Array.from(ne).reduce((e,[t,r])=>(e.set(r,t),e),new Map),se=new RegExp(`^(\\d+)(${Array.from(ne.keys()).join("|")})`),ae=class e extends K{_milliseconds;constructor(t){super(),this._milliseconds=t instanceof e?t._milliseconds:"string"==typeof t?e.parseString(t):t}static fromCompact([t,r]){return new e(1e3*(t=t??0)+(r=r??0)/1e6)}equals(t){return t instanceof e&&this._milliseconds===t._milliseconds}toCompact(){let e=Math.floor(this._milliseconds/1e3),t=Math.floor(1e6*(this._milliseconds-1e3*e));return t>0?[e,t]:e>0?[e]:[]}toString(){let e=this._milliseconds,t="";function r(t){let r=Math.floor(e/t);return r>0&&(e%=t),r}for(let[e,n]of Array.from(ie).reverse()){let i=r(e);i>0&&(t+=`${i}${n}`)}return t}toJSON(){return this.toString()}static parseString(e){let t=0,r=e;for(;""!==r;){let e=r.match(se);if(e){let n=Number.parseInt(e[1]),i=ne.get(e[2]);if(void 0===i)throw new f(`Invalid duration unit: ${e[2]}`);t+=n*i,r=r.slice(e[0].length);continue}throw new f("Could not match a next duration part")}return t}static nanoseconds(t){return new e(Math.floor(t*X))}static microseconds(t){return new e(Math.floor(t*H))}static milliseconds(t){return new e(t)}static seconds(t){return new e(t*Q)}static minutes(t){return new e(t*Z)}static hours(t){return new e(t*ee)}static days(t){return new e(t*te)}static weeks(t){return new e(t*re)}get microseconds(){return Math.floor(this._milliseconds/H)}get nanoseconds(){return Math.floor(this._milliseconds/X)}get milliseconds(){return Math.floor(this._milliseconds)}get seconds(){return Math.floor(this._milliseconds/Q)}get minutes(){return Math.floor(this._milliseconds/Z)}get hours(){return Math.floor(this._milliseconds/ee)}get days(){return Math.floor(this._milliseconds/te)}get weeks(){return Math.floor(this._milliseconds/re)}},oe=class e extends K{constructor(e){super(),this.inner=e}equals(t){return t instanceof e&&this.inner===t.inner}toJSON(){return this.toString()}toString(){return`<future> ${this.inner}`}},ce=class e extends K{equals(t){return t instanceof e&&this.is(t)}toString(){return JSON.stringify(this.toJSON())}};function le(e){return e instanceof Y?Number.parseFloat(e.decimal):e}var he=class e extends ce{point;constructor(t){super(),this.point=t instanceof e?t.clone().point:[le(t[0]),le(t[1])]}toJSON(){return{type:"Point",coordinates:this.coordinates}}get coordinates(){return this.point}is(t){return t instanceof e&&(this.point[0]===t.point[0]&&this.point[1]===t.point[1])}clone(){return new e([...this.point])}},ue=class e extends ce{line;constructor(t){super(),this.line=t instanceof e?t.clone().line:t}toJSON(){return{type:"LineString",coordinates:this.coordinates}}get coordinates(){return this.line.map(e=>e.coordinates)}close(){this.line[0].is(this.line.at(-1))||this.line.push(this.line[0])}is(t){if(!(t instanceof e)||this.line.length!==t.line.length)return!1;for(let e=0;e<this.line.length;e++)if(!this.line[e].is(t.line[e]))return!1;return!0}clone(){return new e(this.line.map(e=>e.clone()))}},de=class e extends ce{polygon;constructor(t){super(),this.polygon=t instanceof e?t.clone().polygon:t.map(e=>{let t=e.clone();return t.close(),t})}toJSON(){return{type:"Polygon",coordinates:this.coordinates}}get coordinates(){return this.polygon.map(e=>e.coordinates)}is(t){if(!(t instanceof e)||this.polygon.length!==t.polygon.length)return!1;for(let e=0;e<this.polygon.length;e++)if(!this.polygon[e].is(t.polygon[e]))return!1;return!0}clone(){return new e(this.polygon.map(e=>e.clone()))}},fe=class e extends ce{points;constructor(t){super(),this.points=t instanceof e?t.points:t}toJSON(){return{type:"MultiPoint",coordinates:this.coordinates}}get coordinates(){return this.points.map(e=>e.coordinates)}is(t){if(!(t instanceof e)||this.points.length!==t.points.length)return!1;for(let e=0;e<this.points.length;e++)if(!this.points[e].is(t.points[e]))return!1;return!0}clone(){return new e(this.points.map(e=>e.clone()))}},we=class e extends ce{lines;constructor(t){super(),this.lines=t instanceof e?t.lines:t}toJSON(){return{type:"MultiLineString",coordinates:this.coordinates}}get coordinates(){return this.lines.map(e=>e.coordinates)}is(t){if(!(t instanceof e)||this.lines.length!==t.lines.length)return!1;for(let e=0;e<this.lines.length;e++)if(!this.lines[e].is(t.lines[e]))return!1;return!0}clone(){return new e(this.lines.map(e=>e.clone()))}},pe=class e extends ce{polygons;constructor(t){super(),this.polygons=t instanceof e?t.polygons:t}toJSON(){return{type:"MultiPolygon",coordinates:this.coordinates}}get coordinates(){return this.polygons.map(e=>e.coordinates)}is(t){if(!(t instanceof e)||this.polygons.length!==t.polygons.length)return!1;for(let e=0;e<this.polygons.length;e++)if(!this.polygons[e].is(t.polygons[e]))return!1;return!0}clone(){return new e(this.polygons.map(e=>e.clone()))}},ge=class e extends ce{collection;constructor(t){super(),this.collection=t instanceof e?t.collection:t}toJSON(){return{type:"GeometryCollection",geometries:this.geometries}}get geometries(){return this.collection.map(e=>e.toJSON())}is(t){if(!(t instanceof e)||this.collection.length!==t.collection.length)return!1;for(let e=0;e<this.collection.length;e++)if(!this.collection[e].is(t.collection[e]))return!1;return!0}clone(){return new e(this.collection.map(e=>e.clone()))}};function ye(e,t){if(Object.is(e,t))return!0;if(e instanceof Date&&t instanceof Date)return e.getTime()===t.getTime();if(e instanceof RegExp&&t instanceof RegExp)return e.toString()===t.toString();if(e instanceof K&&t instanceof K)return e.equals(t);if("object"!=typeof e||null===e||"object"!=typeof t||null===t)return!1;let r=Reflect.ownKeys(e),n=Reflect.ownKeys(t);if(r.length!==n.length)return!1;for(let n=0;n<r.length;n++)if(!Reflect.has(t,r[n])||!ye(e[r[n]],t[r[n]]))return!1;return!0}function me(e){if(function(e){return/^\d+$/.test(e.replace(/_/g,""))}(e))return`⟨${e}⟩`;if(""===e)return"⟨⟩";let t,r,n;for(r=0,n=e.length;r<n;r++)if(t=e.charCodeAt(r),!(t>47&&t<58||t>64&&t<91||t>96&&t<123||95===t))return`⟨${e.replaceAll("⟩","\\⟩")}⟩`;return e}var be=class e extends K{inner;constructor(r){super(),r instanceof ArrayBuffer?this.inner=t.ofInner(new Uint8Array(r)):r instanceof Uint8Array?this.inner=t.ofInner(r):this.inner=r instanceof e?r.inner:r instanceof t?r:t.parse(r)}equals(t){return t instanceof e&&this.inner.equals(t.inner)}toString(){return this.inner.toString()}toJSON(){return this.inner.toString()}toUint8Array(){return this.inner.bytes}toBuffer(){return this.inner.bytes.buffer}static v4(){return new e((s||(s=new r)).generateV4())}static v7(){return new e((s||(s=new r)).generate())}},ve=class e extends K{tb;id;constructor(e,t){if(super(),"string"!=typeof e)throw new f("TB part is not valid");if(!_e(t))throw new f("ID part is not valid");this.tb=e,this.id=t}equals(t){return t instanceof e&&(this.tb===t.tb&&ye(this.id,t.id))}toJSON(){return this.toString()}toString(){return`${me(this.tb)}:${Se(this.id)}`}},ke=class e extends K{rid;constructor(t){if(super(),t instanceof e)this.rid=t.rid;else if(t instanceof ve)this.rid=t.toString();else{if("string"!=typeof t)throw new f("String Record ID must be a string");this.rid=t}}equals(t){return t instanceof e&&this.rid===t.rid}toJSON(){return this.rid}toString(){return this.rid}};function _e(e){if(e instanceof be)return!0;switch(typeof e){case"string":case"number":case"bigint":return!0;case"object":return Array.isArray(e)||null!==e;default:return!1}}function Se(e){return e instanceof be?`u"${e}"`:"string"==typeof e?me(e):"bigint"==typeof e||"number"==typeof e?(t=e)<=9223372036854775807n?t.toString():`⟨${t}⟩`:Ae(e);var t}var xe=class e extends K{tb;constructor(e){if(super(),"string"!=typeof e)throw new f("Table must be a string");this.tb=e}equals(t){return t instanceof e&&this.tb===t.tb}toJSON(){return this.tb}toString(){return this.tb}};function Ae(e){if("string"==typeof e)return`s${JSON.stringify(e)}`;if(null===e)return"NULL";if(void 0===e)return"NONE";if("object"==typeof e){if(e instanceof Date)return`d${JSON.stringify(e.toISOString())}`;if(e instanceof be)return`u${JSON.stringify(e.toString())}`;if(e instanceof ve||e instanceof ke)return`r${JSON.stringify(e.toString())}`;if(e instanceof ce)return Ae(e.toJSON());if(e instanceof Y||e instanceof ae||e instanceof oe||e instanceof Ee||e instanceof xe)return e.toJSON();switch(Object.getPrototypeOf(e)){case Object.prototype:{let t="{ ",r=Object.entries(e);for(let[e,[n,i]]of r.entries())t+=`${JSON.stringify(n)}: ${Ae(i)}`,e<r.length-1&&(t+=", ");return t+=" }",t}case Map.prototype:{let t="{ ",r=Array.from(e.entries());for(let[e,[n,i]]of r.entries())t+=`${JSON.stringify(n)}: ${Ae(i)}`,e<r.length-1&&(t+=", ");return t+=" }",t}case Array.prototype:return`[ ${e.map(Ae).join(", ")} ]`;case Set.prototype:return`[ ${[...new Set([...e].map(Ae))].join(", ")} ]`}}return`${e}`}var Ee=class e extends K{constructor(e,t){super(),this.beg=e,this.end=t}equals(t){return t instanceof e&&this.beg?.constructor===t.beg?.constructor&&this.end?.constructor===t.end?.constructor&&(ye(this.beg?.value,t.beg?.value)&&ye(this.end?.value,t.end?.value))}toJSON(){return this.toString()}toString(){let e=Oe(this.beg),t=Oe(this.end);return`${e}${$e(this.beg,this.end)}${t}`}},Ue=class{constructor(e){this.value=e}},Me=class{constructor(e){this.value=e}},We=class e extends K{constructor(e,t,r){if(super(),this.tb=e,this.beg=t,this.end=r,"string"!=typeof e)throw new f("TB part is not valid");if(!Ne(t))throw new f("Beg part is not valid");if(!Ne(r))throw new f("End part is not valid")}equals(t){return t instanceof e&&this.beg?.constructor===t.beg?.constructor&&this.end?.constructor===t.end?.constructor&&(this.tb===t.tb&&ye(this.beg?.value,t.beg?.value)&&ye(this.end?.value,t.end?.value))}toJSON(){return this.toString()}toString(){let e=me(this.tb),t=De(this.beg),r=De(this.end);return`${e}:${t}${$e(this.beg,this.end)}${r}`}};function $e(e,t){let r="";return e instanceof Me&&(r+=">"),r+="..",t instanceof Ue&&(r+="="),r}function Ne(e){return!(e instanceof Ue||e instanceof Me)||_e(e.value)}function De(e){return e instanceof Ue||e instanceof Me?Se(e.value):""}function Oe(e){if(void 0===e)return"";let t=e.value;return e instanceof Ee?`(${Ae(t)})`:Ae(t)}function Ce([e,t]){function r(e){return e instanceof Ue?new F(je,e.value):e instanceof Me?new F(Re,e.value):null}return[r(e),r(t)]}var je=50,Re=51,Le={encode:e=>e instanceof Date?new F(12,function(e){let t=Math.floor(e.getTime()/1e3);return[t,1e6*(e.getTime()-1e3*t)]}(e)):void 0===e?new F(6,null):e instanceof be?new F(37,e.toBuffer()):e instanceof Y?new F(10,e.toString()):e instanceof ae?new F(14,e.toCompact()):e instanceof ve?new F(8,[e.tb,e.id]):e instanceof ke?new F(8,e.rid):e instanceof We?new F(8,[e.tb,new F(49,Ce([e.beg,e.end]))]):e instanceof xe?new F(7,e.tb):e instanceof oe?new F(15,e.inner):e instanceof Ee?new F(49,Ce([e.beg,e.end])):e instanceof he?new F(88,e.point):e instanceof ue?new F(89,e.line):e instanceof de?new F(90,e.polygon):e instanceof fe?new F(91,e.points):e instanceof we?new F(92,e.lines):e instanceof pe?new F(93,e.polygons):e instanceof ge?new F(94,e.collection):e,decode(e){if(!(e instanceof F))return e;switch(e.tag){case 0:return new Date(e.value);case 37:case 9:return new be(e.value);case 12:return function([e,t]){let r=new Date(0);return r.setUTCSeconds(Number(e)),r.setMilliseconds(Math.floor(Number(t)/1e6)),r}(e.value);case 6:return;case 10:return new Y(e.value);case 13:return new ae(e.value);case 14:return ae.fromCompact(e.value);case 7:return new xe(e.value);case 15:return new oe(e.value);case 49:return new Ee(...function(e){function t(e){if(null!==e){if(e instanceof Ue||e instanceof Me)return e;throw new f("Expected the bounds to be decoded already")}}return[t(e[0]),t(e[1])]}(e.value));case je:return new Ue(e.value);case Re:return new Me(e.value);case 8:return e.value[1]instanceof Ee?new We(e.value[0],e.value[1].beg,e.value[1].end):new ve(e.value[0],e.value[1]);case 88:return new he(e.value);case 89:return new ue(e.value);case 90:return new de(e.value);case 91:return new fe(e.value);case 92:return new we(e.value);case 93:return new pe(e.value);case 94:return new ge(e.value)}}};function Ie(e){return P(e,{replacer:Le.encode})}function qe(e){return G(e,{replacer:Le.decode})}Object.freeze(Le);var Be,Te=class{_query;_bindings;length;constructor(e,t){Be??=new TextEncoder,this._query=Be.encode(e),this._bindings=B(t??{},{replacer:Le.encode}),this.length=Object.keys(this._bindings).length}get query(){let e=new I(this._query.byteLength+9);return e.writeMajor(3,this._query.byteLength),e.writeUint8Array(this._query),new d(e.output(!1))}get bindings(){return this._bindings}build(e){return P([this.query,this.bindings],{fills:e})}append(e,...t){let r=this.length;this.length+=t.length;let n=0,i=new Map,s=t.map((e,t)=>{if(e instanceof l){let r=i.get(e);if(void 0!==r)return n++,[`bind___${r}`,e];i.set(e,t-n)}return["bind___"+(r+t-n),e]});for(let[e,t]of s)this._bindings[e]=P(t,{replacer:Le.encode,partial:!0});let a=e.flatMap((e,t)=>{let r=s[t]?.[0];return[e,...r?[`$${r}`]:[]]}).join("");Be??=new TextEncoder;let o=new Uint8Array(this._query),c=Be.encode(a);return this._query=new Uint8Array(o.byteLength+c.byteLength),this._query.set(o),this._query.set(c,o.byteLength),this}};function Fe(e){let t={},r=(r,n,i)=>{if(r in e)t[n]=`${e[r]}`,delete t[r];else if(!0!==i)throw new f(`Key ${r} is missing from the authentication parameters`)};return"scope"in e?(t={...e},r("scope","sc"),r("namespace","ns"),r("database","db")):"variables"in e?(t={...e.variables},r("access","ac"),r("namespace","ns"),r("database","db")):(r("access","ac",!0),r("database","db",!0),r("namespace","ns",!("database"in e)),r("username","user"),r("password","pass")),t}var Pe=["CREATE","UPDATE","DELETE"];var Je={enabled:!0,attempts:5,retryDelay:1e3,retryDelayMax:6e4,retryDelayMultiplier:2,retryDelayJitter:.1},Ve="1.4.2",ze="3.0.0";function Ge(e,t=Ve,r=ze){if(!function(e,t=Ve,r=ze){return t.localeCompare(e,void 0,{numeric:!0})<=0&&1===r.localeCompare(e,void 0,{numeric:!0})}(e,t,r))throw new W(e,`>= ${t} < ${r}`);return!0}async function Ke(e,t){let r={"ws:":"http:","wss:":"https:","http:":"http:","https:":"https:"}[e.protocol];if(r){let n=e.pathname.slice(0,-4);(e=new URL(e)).pathname=`${n}/version`,e.protocol=r;let i=new AbortController,s=setTimeout(()=>i.abort(),t??5e3),a="surrealdb-";return await fetch(e,{signal:i.signal}).then(e=>e.text()).then(e=>e.slice(a.length)).catch(e=>{throw new $(e)}).finally(()=>{clearTimeout(s)})}throw new $}var Ye=0;function He(){return(Ye=(Ye+1)%Number.MAX_SAFE_INTEGER).toString()}var Xe,Qe=Symbol("RetryMessage"),Ze=((Xe=Ze||{}).Disconnected="disconnected",Xe.Connecting="connecting",Xe.Reconnecting="reconnecting",Xe.Connected="connected",Xe.Error="error",Xe),et=class{emitter;encodeCbor;decodeCbor;reconnect;prepare;constructor({emitter:e,encodeCbor:t,decodeCbor:r,reconnect:n,prepare:i}){this.emitter=e,this.encodeCbor=t,this.decodeCbor=r,this.reconnect=n,this.prepare=i}},tt=class{context;ready;status="disconnected";connection={url:void 0,namespace:void 0,database:void 0,token:void 0};constructor(e){this.context=e}get emitter(){return this.context.emitter}get encodeCbor(){return this.context.encodeCbor}get decodeCbor(){return this.context.decodeCbor}};function rt(e,t){if("scope"in e||"access"in e&&"variables"in e&&e.variables){if(!e.namespace){if(!t?.namespace)throw new E;e.namespace=t.namespace}if(!e.database){if(!t?.database)throw new U;e.database=t.database}}return e}var nt=class{async signup(e){if(!this.connection)throw new w;let t=Fe(rt(e,this.connection.connection)),r=await this.rpc("signup",[t]);if(r.error)throw new A(r.error.message);if(!r.result)throw new M;return r.result}async signin(e){if(!this.connection)throw new w;let t=Fe(rt(e,this.connection.connection)),r=await this.rpc("signin",[t]);if(r.error)throw new A(r.error.message);if(!r.result)throw new M;return r.result}async authenticate(e){let t=await this.rpc("authenticate",[e]);if(t.error)throw new A(t.error.message);return!0}async invalidate(){let e=await this.rpc("invalidate");if(e.error)throw new A(e.error.message);return!0}},it=class extends nt{constructor(e){super(),this.connection=e}rpc(e,t){if(!this.connection)throw new w;return this.connection.rpc({method:e,params:t},!0)}},st=class extends tt{async req_post(e,t,r){let n={"Content-Type":"application/cbor",Accept:"application/cbor",...r};this.connection.namespace&&(n["Surreal-NS"]=this.connection.namespace),this.connection.database&&(n["Surreal-DB"]=this.connection.database),this.connection.token&&(n.Authorization=`Bearer ${this.connection.token}`);let i=await fetch(`${t??this.connection.url}`,{method:"POST",headers:n,body:this.encodeCbor(e)}),s=await i.arrayBuffer();if(200===i.status)return s;let a=new TextDecoder("utf-8");throw new x(a.decode(s),i.status,i.statusText,s)}},at=new Set(["signin","signup","authenticate","invalidate","version","use","let","unset","query"]),ot=class extends st{connection={url:void 0,namespace:void 0,database:void 0,token:void 0,variables:{}};setStatus(e,...t){this.status=e,this.emitter.emit(e,t)}version(e,t){return Ke(e,t)}async connect(e){return this.setStatus("connecting"),this.connection.url=e,await(this.context.prepare?.(new it(this))),this.setStatus("connected"),this.ready=new Promise(e=>e()),this.ready}disconnect(){return this.connection={url:void 0,namespace:void 0,database:void 0,token:void 0,variables:{}},this.ready=void 0,this.setStatus("disconnected"),new Promise(e=>e())}async rpc(e,t){if(t||await this.ready,!this.connection.url)throw new _;if(!(this.connection.namespace&&this.connection.database||at.has(e.method)))throw new S;if("use"===e.method){let[t,r]=e.params;return null===t&&(this.connection.namespace=void 0),null===r&&(this.connection.database=void 0),t&&(this.connection.namespace=t),r&&(this.connection.database=r),{result:!0}}if("let"===e.method){let[t,r]=e.params;return this.connection.variables[t]=r,{result:!0}}if("unset"===e.method){let[t]=e.params;return delete this.connection.variables[t],{result:!0}}"query"===e.method&&(e.params=[e.params?.[0],{...this.connection.variables,...e.params?.[1]??{}}]);let r=He(),n=await this.req_post({id:r,...e}),i=this.decodeCbor(n);if("result"in i)switch(e.method){case"signin":case"signup":this.connection.token=i.result;break;case"authenticate":{let[t]=e.params;this.connection.token=t;break}case"invalidate":this.connection.token=void 0}return this.emitter.emit(`rpc-${r}`,[i]),i}get connected(){return!!this.connection.url}async export(e){if(!this.connection.url)throw new _;let t=new URL(this.connection.url),r=t.pathname.slice(0,-4);t.pathname=`${r}/export`;let n=await this.req_post(e??{},t,{Accept:"plain/text"});return new TextDecoder("utf-8").decode(n)}async import(e){if(!this.connection.url)throw new _;let t=new URL(this.connection.url),r=t.pathname.slice(0,-4);t.pathname=`${r}/import`,await this.req_post(e,t,{Accept:"application/json"})}};function ct(){let e={completed:!1};return e.promise=new Promise((t,r)=>{e.resolve=r=>{e.completed=!0,t(r)},e.reject=t=>{e.completed=!0,r(t)}}),e}var lt=class extends st{pinger;socket;disconnected;constructor(e){super(e),this.disconnected=ct()}setStatus(e,...t){this.connection.url&&"disconnected"===e||"error"===e?(this.disconnected.resolve(),this.disconnected=ct()):(this.status=e,this.emitter.emit(e,t))}async requireStatus(e){return this.status!==e&&await this.emitter.subscribeOnce(e),!0}version(e,t){return Ke(e,t)}async connect(e){this.connection.url=e,(async()=>{let e,t=!0;for(;this.connection.url;)if(t)t=!1,this.setStatus("connecting"),this.ready=this.createSocket(),await this.disconnected.promise;else{if(!this.context.reconnect.enabled)break;if(!e){let{promise:t,resolve:r,reject:n}=ct();this.ready=t,e=[r,n]}let[t,r]=e;if(!this.context.reconnect.allowed){this.connection={url:void 0,namespace:void 0,database:void 0,token:void 0},this.socket=void 0,r(new y),this.emitter.emit("error",[new y]),this.setStatus("disconnected");break}this.setStatus("reconnecting"),await this.context.reconnect.iterate();try{await this.createSocket()}catch{continue}try{if(this.connection.namespace||this.connection.database){let e=await this.rpc({method:"use",params:[this.connection.namespace,this.connection.database]},!0);if(e.error)throw new A(e.error.message)}if(this.connection.token){let e=await this.rpc({method:"authenticate",params:[this.connection.token]},!0);if(e.error)throw new A(e.error.message)}}catch(e){this.connection={url:void 0,namespace:void 0,database:void 0,token:void 0},this.socket=void 0,r(e),this.emitter.emit("error",[e]),this.setStatus("disconnected");break}this.context.reconnect.reset(),t(),this.emitter.scanListeners(e=>e.startsWith("rpc-")).map(e=>this.emitter.emit(e,[Qe])),"connected"===this.status&&await this.disconnected.promise}})(),await this.ready}async createSocket(){let{promise:e,resolve:t,reject:r}=ct();if(!this.connection.url)throw new p;let n=new a(this.connection.url.toString(),"cbor");n.addEventListener("open",async()=>{this.socket=n,await(this.context.prepare?.(new it(this))),this.setStatus("connected"),this.pinger?.stop(),this.pinger=new ht(3e4),this.pinger.start(()=>{try{this.rpc({method:"ping"})}catch{}}),t()}),n.addEventListener("error",e=>{let t=new v("detail"in e&&e.detail?e.detail:"message"in e&&e.message?e.message:"error"in e&&e.error?e.error:"An unexpected error occurred");this.setStatus("error",t),r(t)}),n.addEventListener("close",()=>{this.setStatus("disconnected"),this.pinger?.stop()}),n.addEventListener("message",async({data:e})=>{try{let t=this.decodeCbor(e instanceof ArrayBuffer?e:e instanceof Blob?await e.arrayBuffer():e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength));if("object"!=typeof t||null==t||Object.getPrototypeOf(t)!==Object.prototype)throw new b(t);this.handleRpcResponse(t)}catch(e){n.dispatchEvent(new CustomEvent("error",{detail:e}))}}),await e}async disconnect(){this.connection={url:void 0,namespace:void 0,database:void 0,token:void 0},await(this.ready?.catch(()=>{})),this.socket?.close(),this.ready=void 0,this.socket=void 0,this.disconnected.resolve(),await Promise.any([this.requireStatus("disconnected"),this.requireStatus("error")])}async rpc(e,t){if(t||await this.ready,!this.socket)throw new _;let r;for(;!r;){let n=He(),i=this.emitter.subscribeOnce(`rpc-${n}`);if(this.socket.send(this.encodeCbor({id:n,...e})),t&&this.socket.readyState===a.CLOSED)throw new g;let[s]=await i;if(s instanceof g)throw s;s!==Qe&&(r=s)}if("result"in r)switch(e.method){case"use":{let[t,r]=e.params;null===t&&(this.connection.namespace=void 0),null===r&&(this.connection.database=void 0),t&&(this.connection.namespace=t),r&&(this.connection.database=r);break}case"signin":case"signup":this.connection.token=r.result;break;case"authenticate":{let[t]=e.params;this.connection.token=t;break}case"invalidate":this.connection.token=void 0}return r}handleRpcResponse({id:e,...t}){if(e)this.emitter.emit(`rpc-${e}`,[t]);else if(t.error)this.setStatus("error",new A(t.error));else if("object"==typeof(r=t.result)&&null!==r&&"id"in r&&"action"in r&&"result"in r&&r.id instanceof be&&Pe.includes(r.action)&&"object"==typeof r.result&&null!==r.result){let{id:e,action:r,result:n}=t.result;this.emitter.emit(`live-${e}`,[r,n],!0)}else this.setStatus("error",new b({id:e,...t}));var r}get connected(){return!!this.socket}async export(e){if(!this.connection.url)throw new _;let t=new URL(this.connection.url),r=t.pathname.slice(0,-4);t.protocol=t.protocol.replace("ws","http"),t.pathname=`${r}/export`;let n=await this.req_post(e??{},t,{Accept:"plain/text"});return new TextDecoder("utf-8").decode(n)}async import(e){if(!this.connection.url)throw new _;let t=new URL(this.connection.url),r=t.pathname.slice(0,-4);t.protocol=t.protocol.replace("ws","http"),t.pathname=`${r}/import`,await this.req_post(e,t,{Accept:"application/json"})}},ht=class{pinger;interval;constructor(e=3e4){this.interval=e}start(e){this.pinger=setInterval(e,this.interval)}stop(){clearInterval(this.pinger)}};var ut=class{_attempts=0;options;surreal;constructor(e,t){this.surreal=t,this.options=e?!0===e?Je:{...Je,...e}:{...Je,enabled:!1}}get attempts(){return this._attempts}get enabled(){return this.options.enabled}get allowed(){return!(!this.options.enabled||-1!==this.options.attempts&&this._attempts>=this.options.attempts)}reset(){this._attempts=0}async iterate(){if(!this.allowed)throw new m;this._attempts++;let e=this.options.retryDelayMultiplier**this.attempts,t=this.options.retryDelay*e,r=(i=-this.options.retryDelayJitter,s=this.options.retryDelayJitter,Math.random()*(s-i)+i),n=Math.min(t*(1+r),this.options.retryDelayMax);var i,s;await new Promise(e=>setTimeout(e,n))}},dt=class extends nt{connection;emitter;engines={ws:lt,wss:lt,http:ot,https:ot};_ready;constructor({engines:e}={}){super(),this.emitter=new c,e&&(this.engines={...this.engines,...e})}async connect(e,t={}){return this._ready=this.connectInner(e,t),await this._ready,!0}async connectInner(e,t={}){let r=function(e){let t=new URL(e);return t.pathname.endsWith("/rpc")||(t.pathname.endsWith("/")||(t.pathname+="/"),t.pathname+="rpc"),t}(e),n=r.protocol.slice(0,-1),i=this.engines[n];if(!i)throw new k(n);let{prepare:s,auth:a,namespace:o,database:c,reconnect:l}=t;await this.close();let h=new i(new et({emitter:this.emitter,encodeCbor:Ie,decodeCbor:qe,reconnect:new ut(l,this),prepare:s}));if(!1!==t.versionCheck){Ge(await h.version(r,t.versionCheckTimeout))}this.connection=h,await h.connect(r),(o||c)&&await this.use({namespace:o,database:c}),"string"==typeof a?await this.authenticate(a):a&&await this.signin(a)}async close(){return this.clean(),await(this.connection?.disconnect()),!0}clean(){let e=this.emitter.scanListeners(e=>e.startsWith("rpc-"));e.map(e=>this.emitter.emit(e,[new g]));let t=this.emitter.scanListeners(e=>e.startsWith("live-"));t.map(e=>this.emitter.emit(e,["CLOSE","disconnected"])),this.emitter.reset({collectable:!0,listeners:[...e,...t]})}get status(){return this.connection?.status??"disconnected"}get ready(){return Promise.all([this._ready,this.connection?.ready]).then(()=>{})}async ping(){let{error:e}=await this.rpc("ping");if(e)throw new A(e.message);return!0}async use({namespace:e,database:t}){if(!this.connection)throw new w;if(null===e&&null!==t)throw new f("Cannot unset namespace without unsetting database");let{error:r}=await this.rpc("use",[e,t]);if(r)throw new A(r.message);return!0}async info(){await this.ready;let e=await this.rpc("info");if(e.error)throw new A(e.error.message);return e.result??void 0}async let(e,t){let r=await this.rpc("let",[e,t]);if(r.error)throw new A(r.error.message);return!0}async unset(e){let t=await this.rpc("unset",[e]);if(t.error)throw new A(t.error.message);return!0}async live(e,t,r){await this.ready;let n=await this.rpc("live",[e,r]);if(n.error)throw new A(n.error.message);return t&&this.subscribeLive(n.result,t),n.result}async subscribeLive(e,t){if(await this.ready,!this.connection)throw new w;this.connection.emitter.subscribe(`live-${e}`,t,!0)}async unSubscribeLive(e,t){if(await this.ready,!this.connection)throw new w;this.connection.emitter.unSubscribe(`live-${e}`,t)}async kill(e){if(await this.ready,!this.connection)throw new w;if(Array.isArray(e)){await Promise.all(e.map(e=>this.rpc("kill",[e])));let t=e.map(e=>`live-${e}`);t.map(e=>this.emitter.emit(e,["CLOSE","killed"])),this.connection.emitter.reset({collectable:t,listeners:t})}else await this.rpc("kill",[e]),this.emitter.emit(`live-${e}`,["CLOSE","killed"]),this.connection.emitter.reset({collectable:`live-${e}`,listeners:`live-${e}`})}async query(...e){return(await this.queryRaw(...e)).map(({status:e,result:t})=>{if("ERR"===e)throw new A(t);return t})}async queryRaw(...[e,t]){let r=e instanceof Te?[e.query,B(e.bindings,{fills:t,replacer:Le.encode})]:[e,t];await this.ready;let n=await this.rpc("query",r);if(n.error)throw new A(n.error.message);return n.result}async query_raw(...e){return this.queryRaw(...e)}async select(e){await this.ready;let t=await this.rpc("select",[e]);if(t.error)throw new A(t.error.message);return ft(e,t.result)}async create(e,t){await this.ready;let r=await this.rpc("create",[e,t]);if(r.error)throw new A(r.error.message);return ft(e,r.result)}async insert(e,t){await this.ready;let[r,n]="string"==typeof e||e instanceof xe?[e,t]:[void 0,e],i=await this.rpc("insert",[r,n]);if(i.error)throw new A(i.error.message);return i.result}async insertRelation(e,t){await this.ready;let[r,n]="string"==typeof e||e instanceof xe?[e,t]:[void 0,e],i=await this.rpc("insert_relation",[r,n]);if(i.error)throw new A(i.error.message);return i.result}async insert_relation(e,t){return e instanceof xe||"string"==typeof e?this.insertRelation(e,t):this.insertRelation(e)}async update(e,t){await this.ready;let r=await this.rpc("update",[e,t]);if(r.error)throw new A(r.error.message);return ft(e,r.result)}async upsert(e,t){await this.ready;let r=await this.rpc("upsert",[e,t]);if(r.error)throw new A(r.error.message);return ft(e,r.result)}async merge(e,t){await this.ready;let r=await this.rpc("merge",[e,t]);if(r.error)throw new A(r.error.message);return ft(e,r.result)}async patch(e,t,r){await this.ready;let n=await this.rpc("patch",[e,t,r]);if(n.error)throw new A(n.error.message);return r?n.result:ft(e,n.result)}async delete(e){await this.ready;let t=await this.rpc("delete",[e]);if(t.error)throw new A(t.error.message);return ft(e,t.result)}async version(){await this.ready;let e=await this.rpc("version");if(e.error)throw new A(e.error.message);return e.result}async run(e,t,r){await this.ready;let[n,i]=Array.isArray(t)?[void 0,t]:[t,r],s=await this.rpc("run",[e,n,i]);if(s.error)throw new A(s.error.message);return s.result}async relate(e,t,r,n){await this.ready;let i=await this.rpc("relate",[e,t,r,n]);if(i.error)throw new A(i.error.message);return ft(t,i.result)}rpc(e,t){if(!this.connection)throw new w;return this.connection.rpc({method:e,params:t})}async export(e){if(await this.ready,!this.connection)throw new w;return this.connection.export(e)}async import(e){if(await this.ready,!this.connection)throw new w;return this.connection.import(e)}};function ft(e,t){return e instanceof ve||e instanceof ke?Array.isArray(t)?t[0]:t:Array.isArray(t)?t:[t]}const wt="https://unpkg.com/@surrealdb/wasm@1.4.1/dist/surreal/index_bg.wasm",pt="https://unpkg.com/@surrealdb/wasm@1.4.1/dist/surreal/index.js",gt="surrealdb-wasm-cache",yt="tokens",mt="data";let bt=null,vt=null,kt=!1,_t=!1,St=!1,xt=null;const At={};let Et=null;const Ut=new Map;let Mt=null;async function Wt(){try{console.log("ServiceWorker: Precaching SurrealDB WASM files...");const e=await caches.open(gt),t=await e.match(wt),r=await e.match(pt);t||(console.log("ServiceWorker: Caching WASM file..."),await e.add(wt)),r||(console.log("ServiceWorker: Caching JS file..."),await e.add(pt)),console.log("ServiceWorker: SurrealDB WASM files cached successfully")}catch(e){console.error("ServiceWorker: Failed to precache SurrealDB WASM files:",e)}}async function $t(){return new Promise((e,t)=>{const r=self.indexedDB.open("surrealdb-local-storage",1);r.onerror=()=>{console.error("ServiceWorker: Failed to open IndexedDB"),t(new Error("Failed to open IndexedDB"))},r.onsuccess=()=>{Et=r.result,console.log("ServiceWorker: IndexedDB initialized successfully"),e()},r.onupgradeneeded=e=>{const t=e.target.result;if(!t.objectStoreNames.contains(yt)){t.createObjectStore(yt,{keyPath:"key"}).createIndex("key","key",{unique:!0})}if(!t.objectStoreNames.contains(mt)){t.createObjectStore(mt,{keyPath:"id"}).createIndex("id","id",{unique:!0})}}})}async function Nt(e,t,r){return Et||await $t(),new Promise((n,i)=>{const s=Et.transaction([e],"readwrite").objectStore(e).put({key:t,value:r});s.onsuccess=()=>{n()},s.onerror=()=>{i(new Error(`Failed to set ${t} in ${e}`))}})}async function Dt(){if(!St||!vt)try{console.log("ServiceWorker: Initializing SurrealDB WASM...");const e=await caches.open(gt);if(!await e.match(pt))throw new Error("SurrealDB WASM JS file not found in cache");const t=await import(pt);vt=new t.Surreal,await vt.connect("mem://"),await vt.use({namespace:"local",database:"storage"}),St=!0,console.log("ServiceWorker: SurrealDB WASM initialized successfully")}catch(e){throw console.error("ServiceWorker: Failed to initialize SurrealDB WASM:",e),e}}async function Ot(e){try{if(vt){const t=await vt.select(`token:${e}`);if(t&&t.length>0)return t[0].value}return await async function(e,t){return Et||await $t(),new Promise((r,n)=>{const i=Et.transaction([e],"readonly").objectStore(e).get(t);i.onsuccess=()=>{r(i.result?.value||null)},i.onerror=()=>{n(new Error(`Failed to get ${t} from ${e}`))}})}(yt,e)}catch(t){return console.error(`ServiceWorker: Failed to get token ${e}:`,t),null}}function Ct(e){if(null==e)return e;if("object"==typeof e&&e.hasOwnProperty("id")&&e.hasOwnProperty("tb"))return new ve(e.tb,e.id);if(Array.isArray(e))return e.map(e=>Ct(e));if("object"==typeof e){const t={};for(const[r,n]of Object.entries(e))t[r]=Ct(n);if(0!==Object.entries(t).length)return t}return e}function jt(e,t){null===t?delete At[e]:At[e]=t,async function(e,t){try{null===t?await Nt(yt,e,null):await Nt(yt,e,t),vt&&(null===t?await vt.delete(`token:${e}`):await vt.create(`token:${e}`,{key:e,value:t,timestamp:Date.now()}))}catch(t){console.error(`ServiceWorker: Failed to store token ${e}:`,t)}}(e,t).catch(t=>{console.warn(`ServiceWorker: Failed to store ${e} in WASM/IndexedDB:`,t)})}function Rt(e){return At[e]??null}async function Lt(e){const t=At[e];if(t)return t;try{const t=await Ot(e);if(t)return At[e]=t,t}catch(t){console.warn(`ServiceWorker: Failed to get ${e} from WASM/IndexedDB:`,t)}return null}async function It(e,t){const r=await self.clients.get(e);r?r.postMessage(t):console.warn(`ServiceWorker: Client with ID ${e} not found.`)}async function qt(e,t){for(const r of t)await It(r,e)}async function Bt(){let e=Rt("tenant_code");return e||(e=await Lt("tenant_code")),!!e||(jt("access_token",null),jt("refresh_token",null),jt("token_expires_at",null),Tt({type:"tenant_code_missing",payload:{message:"Tenant code is missing, user needs to login again"}}),!1)}async function Tt(e){const t=await self.clients.matchAll();for(const r of t)r.postMessage(e)}async function Ft(){try{let e=Rt("refresh_token");if(e||(e=await Lt("refresh_token")),!e)return console.error("ServiceWorker: No refresh token available"),!1;const t=(void 0).VITE_API_URL||"http://localhost:8082",r=await fetch(`${t}/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:e})}),n=await r.json();if(501===r.status)return console.warn("ServiceWorker: Token refresh not yet implemented on backend:",n.message),Pt(),!1;if(!r.ok)throw new Error("Failed to refresh token");if(n.access_token){if(jt("access_token",n.access_token),n.refresh_token&&jt("refresh_token",n.refresh_token),n.expires_in){jt("token_expires_at",(Date.now()+1e3*n.expires_in).toString())}return kt&&bt&&await bt.authenticate(n.access_token),console.log("ServiceWorker: Access token refreshed successfully"),Tt({type:"token_refreshed",payload:{success:!0}}),!0}return!1}catch(e){return console.error("ServiceWorker: Error refreshing access token:",e),!1}}function Pt(){jt("access_token",null),jt("refresh_token",null),jt("token_expires_at",null),Tt({type:"auth_state_cleared",payload:{message:"Authentication state cleared due to token refresh failure"}})}async function Jt(){if(!await Bt())return console.log("ServiceWorker: Tenant code missing, user needs to login again"),void Pt();let e=Rt("token_expires_at");if(e||(e=await Lt("token_expires_at")),!e)return;const t=parseInt(e,10)-Date.now();if(t<=6e5&&t>0){console.log("ServiceWorker: Token expiring soon, attempting refresh...");await Ft()||(console.error("ServiceWorker: Failed to refresh token, clearing auth state"),Pt())}}function Vt(){Mt&&(clearInterval(Mt),Mt=null),Mt=setInterval(Jt,3e5),setTimeout(Jt,1e3),console.log("ServiceWorker: Token refresh timer set up")}function zt(){Mt&&(clearInterval(Mt),Mt=null,console.log("ServiceWorker: Token refresh timer cleared"))}async function Gt(e){if(await async function(){if(!_t||bt?.connection?.status!==Ze.Connected)try{bt=new dt,_t=!0,console.log("ServiceWorker: SurrealDB initialized successfully")}catch(e){throw console.error("ServiceWorker: Failed to initialize SurrealDB:",e),e}}(),e&&xt){const t=xt.endpoint!==e.endpoint,r=xt.namespace!==e.namespace,n=xt.database!==e.database,i=JSON.stringify(xt.auth)!==JSON.stringify(e.auth);if(t){if(console.log("ServiceWorker: Endpoint changed, reconnecting...",xt.endpoint,"->",e.endpoint),kt&&bt)try{await bt.close()}catch(e){console.warn("ServiceWorker: Error closing connection:",e)}kt=!1,xt=e}else if(r||n){if(console.log("ServiceWorker: Namespace/Database changed, switching...",{namespace:xt.namespace,database:xt.database},"->",{namespace:e.namespace,database:e.database}),kt&&bt)try{await bt.use({namespace:e.namespace,database:e.database});let t=Rt("access_token");t||(t=await Lt("access_token")),t&&(await bt.authenticate(t),console.log("ServiceWorker: Re-authenticated after namespace/database change."))}catch(e){console.error("ServiceWorker: Failed to switch namespace/database:",e),kt=!1}xt=e}else if(i){if(console.log("ServiceWorker: Auth changed, re-authenticating..."),kt&&bt)try{let e=Rt("access_token");e||(e=await Lt("access_token")),e&&(await bt.authenticate(e),console.log("ServiceWorker: Re-authenticated with new auth info."))}catch(e){console.error("ServiceWorker: Re-authentication failed:",e)}xt=e}else xt=e}else e&&(xt=e);if(!xt)return console.error("ServiceWorker: Connection config not set."),!1;if(!kt)try{console.log(`ServiceWorker: Connecting to ${xt.endpoint}...`),await bt.connect(xt.endpoint),await bt.use({namespace:xt.namespace,database:xt.database});let e=Rt("access_token");if(e||(e=await Lt("access_token")),e)try{await bt.authenticate(e),console.log("ServiceWorker: Re-authenticated successfully with stored token.");let t=Rt("refresh_token"),r=Rt("token_expires_at");t||(t=await Lt("refresh_token")),r||(r=await Lt("token_expires_at")),t&&r&&Vt()}catch(e){console.warn("ServiceWorker: Stored token authentication failed.",e),jt("access_token",null),jt("refresh_token",null),jt("token_expires_at",null),zt()}kt=!0,console.log("ServiceWorker: Connection established."),await async function(){console.log("ServiceWorker: Resubscribing to all live queries...");for(const[e,t]of Ut.entries())try{if(!bt)throw new Error("Database not initialized");await bt.live(t.query,(r,n)=>{qt({type:"live_update",payload:{uuid:e,action:r,result:n}},t.clients)}),console.log(`ServiceWorker: Successfully resubscribed to live query ${e}`)}catch(t){console.error(`ServiceWorker: Failed to resubscribe to live query ${e}`,t)}}()}catch(e){return console.error("ServiceWorker: Connection failed.",e),kt=!1,!1}return!0}async function Kt(){try{console.log("ServiceWorker: Recovering tokens from WASM/IndexedDB...");const e=["access_token","refresh_token","token_expires_at","tenant_code"];for(const t of e){const e=await Ot(t);e&&(At[t]=e,console.log(`ServiceWorker: Recovered ${t} from storage`))}console.log("ServiceWorker: Token recovery completed")}catch(e){console.error("ServiceWorker: Failed to recover tokens from storage:",e)}}self.addEventListener("install",e=>{console.log("Service Worker installing"),e.waitUntil(Promise.all([self.skipWaiting(),Wt(),$t()]))}),self.addEventListener("activate",e=>{console.log("Service Worker activating"),e.waitUntil(self.clients.claim().then(async()=>{await Dt(),await Kt(),await async function(){try{const e=await self.clients.matchAll();e.length>0&&e[0].postMessage({type:"request_token_sync",payload:{}})}catch(e){console.error("ServiceWorker: Failed to sync tokens from localStorage:",e)}}()}))}),self.addEventListener("beforeunload",()=>{zt()}),self.addEventListener("message",async e=>{if(!e.data||!e.data.type)return;const{type:t,payload:r,messageId:n}=Ct(e.data),i=e.source?.id;if(!i)return;const s=e=>It(i,{type:`${t}_response`,messageId:n,payload:e}),a=e=>It(i,{type:`${t}_error`,messageId:n,payload:{message:e.message,stack:e.stack}});try{switch(t){case"connect":r.sync_tokens&&(r.sync_tokens.access_token&&jt("access_token",r.sync_tokens.access_token),r.sync_tokens.refresh_token&&jt("refresh_token",r.sync_tokens.refresh_token),r.sync_tokens.token_expires_at&&jt("token_expires_at",r.sync_tokens.token_expires_at),r.sync_tokens.tenant_code&&jt("tenant_code",r.sync_tokens.tenant_code)),await Gt(r),s({status:kt?"connected":"disconnected"});break;case"authenticate":if(jt("access_token",r.token),r.refresh_token&&jt("refresh_token",r.refresh_token),r.expires_in){jt("token_expires_at",(Date.now()+1e3*r.expires_in).toString())}if(r.tenant_code&&jt("tenant_code",r.tenant_code),await Gt(),!kt)throw new Error("Connection not established.");await bt.authenticate(r.token),Vt(),s({success:!0});break;case"invalidate":jt("access_token",null),jt("refresh_token",null),jt("token_expires_at",null),zt(),kt&&await bt.invalidate(),s({success:!0});break;case"query":case"mutate":{if(await Gt(),!bt)throw new Error("Database not initialized");const[e]=await bt.query(r.sql,r.vars);s(e);break}case"create":if(await Gt(),!bt)throw new Error("Database not initialized");s(await bt.create(r.thing,r.data));break;case"select":if(await Gt(),!bt)throw new Error("Database not initialized");s(await bt.select(r.thing));break;case"update":if(await Gt(),!bt)throw new Error("Database not initialized");s(await bt.update(r.thing,r.data));break;case"merge":if(await Gt(),!bt)throw new Error("Database not initialized");s(await bt.merge(r.thing,r.data));break;case"delete":if(await Gt(),!bt)throw new Error("Database not initialized");s(await bt.delete(r.thing));break;case"live":{if(await Gt(),!bt)throw new Error("Database not initialized");const{query:e,vars:t}=r,n=e,a=await bt.live(n,(e,t)=>{const r=Ut.get(String(a));r&&qt({type:"live_update",payload:{uuid:String(a),action:e,result:t}},r.clients)}),o=String(a);Ut.has(o)||Ut.set(o,{query:e,vars:t,clients:new Set}),Ut.get(o).clients.add(i),s({uuid:o});break}case"kill":{const{uuid:e}=r,t=Ut.get(e);t&&(t.clients.delete(i),0===t.clients.size&&bt&&(await bt.kill(e),Ut.delete(e),console.log(`ServiceWorker: Killed live query ${e} as no clients are listening.`))),s({success:!0});break}case"setup_token_refresh":Vt(),s({success:!0});break;case"clear_token_refresh":zt(),s({success:!0});break;case"refresh_token":s({success:await Ft()});break;case"check_tenant_code":s({valid:await Bt()});break;case"wasm_query":if(await Dt(),!vt)throw new Error("WASM database not initialized");s(await vt.query(r.sql,r.vars));break;case"wasm_create":if(await Dt(),!vt)throw new Error("WASM database not initialized");s(await vt.create(r.thing,r.data));break;case"wasm_select":if(await Dt(),!vt)throw new Error("WASM database not initialized");s(await vt.select(r.thing));break;case"wasm_update":if(await Dt(),!vt)throw new Error("WASM database not initialized");s(await vt.update(r.thing,r.data));break;case"wasm_delete":if(await Dt(),!vt)throw new Error("WASM database not initialized");s(await vt.delete(r.thing));break;case"recover_tokens":await Kt(),s({success:!0});break;default:console.warn(`ServiceWorker: Unknown message type received: ${t}`),a(new Error(`Unknown message type: ${t}`))}}catch(e){console.error(`ServiceWorker: Error processing message type ${t}:`,e),a(e)}}),console.log("Service Worker loaded")}();
