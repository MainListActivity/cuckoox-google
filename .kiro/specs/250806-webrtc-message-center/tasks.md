# 实施计划

- [ ] 1. 完善WebRTC数据库架构和配置管理
  - 创建缺失的WebRTC相关数据表（call_record、webrtc_signal、user_webrtc_status、system_config）
  - 实现客户端配置管理服务，支持配置缓存和实时同步
  - _需求: 1.1, 5.1, 5.2_

- [ ] 1.1 完善WebRTC数据库表结构
  - 在surreal_schemas.surql中添加缺失的call_record、webrtc_signal、user_webrtc_status、system_config表
  - 插入WebRTC默认配置数据，包含STUN服务器、文件限制、功能开关等
  - _需求: 5.1, 5.2_

- [ ] 1.2 实现RTCConfigService配置管理服务
  - 创建src/services/rtcConfigService.ts，实现配置获取、缓存和同步功能
  - 支持从SurrealDB获取配置并缓存到本地，监听配置变更实时更新
  - _需求: 5.1, 5.2_

- [ ] 1.3 创建RTCConfigManager配置管理器
  - 实现配置初始化、订阅变更、本地缓存管理功能
  - 提供配置访问接口供其他WebRTC组件使用
  - _需求: 5.1, 5.2_

- [ ] 2. 实现WebRTC核心管理器和信令服务
  - 创建WebRTC连接管理器，处理RTCPeerConnection生命周期
  - 基于SurrealDB Live Query实现信令服务，支持offer/answer/ice-candidate交换
  - _需求: 2.1, 2.2, 3.1, 3.2_

- [ ] 2.1 创建WebRTCManager核心管理器
  - 创建src/services/webrtcManager.ts，实现RTCPeerConnection创建和管理
  - 支持创建、配置、关闭peer连接，处理ICE候选和媒体流
  - _需求: 2.1, 2.2, 3.1, 3.2_

- [ ] 2.2 实现SignalingService信令服务
  - 创建src/services/signalingService.ts，基于SurrealDB实现信令消息传递
  - 支持发送和接收offer、answer、ice-candidate等信令消息
  - _需求: 2.1, 2.2, 3.1, 3.2_

- [ ] 2.3 创建WebRTC信令消息数据表
  - 在surreal_schemas.surql中定义webrtc_signal表结构
  - 支持存储和查询各类信令消息，包含消息类型、发送方、接收方等信息
  - _需求: 2.1, 2.2, 3.1, 3.2_

- [ ] 3. 实现P2P文件传输功能
  - 创建文件传输管理器，支持文件分片、传输进度、重组功能
  - 扩展消息表支持多媒体消息类型，集成文件元数据存储
  - _需求: 1.1, 1.2, 1.3, 1.4, 1.5_

- [ ] 3.1 创建MediaFileHandler文件处理器
  - 创建src/services/mediaFileHandler.ts，实现文件分片、重组、验证功能
  - 支持图片压缩、缩略图生成、文件类型验证等预处理功能
  - _需求: 1.1, 1.2, 1.3_

- [ ] 3.2 实现P2P文件传输核心功能
  - 在MediaFileHandler中实现基于RTCDataChannel的文件传输
  - 支持文件分片传输、传输进度监控、传输状态管理
  - _需求: 1.1, 1.4, 1.5_

- [ ] 3.3 扩展Message表支持多媒体消息
  - 在surreal_schemas.surql中为message表添加message_type、file_metadata字段
  - 定义文件元数据结构，包含文件名、大小、哈希、缩略图等信息
  - _需求: 1.1, 1.2, 1.3_

- [ ] 4. 实现语音通话功能
  - 创建通话管理器，支持发起、接听、拒绝、结束语音通话
  - 实现通话界面组件，提供静音、扬声器、挂断等控制功能
  - _需求: 2.1, 2.2, 2.3, 2.4, 2.5_

- [ ] 4.1 创建CallManager通话管理器
  - 创建src/services/callManager.ts，实现通话会话管理和媒体流控制
  - 支持发起通话、接听通话、通话状态管理、媒体设备控制
  - _需求: 2.1, 2.2, 2.3, 2.4, 2.5_

- [ ] 4.2 实现语音通话界面组件
  - 创建src/components/webrtc/AudioCallInterface.tsx语音通话界面
  - 提供通话时长显示、静音控制、扬声器切换、挂断等功能
  - _需求: 2.3, 2.4_

- [ ] 4.3 创建通话记录数据表
  - 在surreal_schemas.surql中定义call_record表结构
  - 支持记录通话历史、参与者、时长、状态等信息
  - _需求: 2.5_

- [ ] 5. 实现视频通话功能
  - 扩展通话管理器支持视频通话，处理摄像头和屏幕共享
  - 创建视频通话界面，支持双方视频显示和画面控制
  - _需求: 3.1, 3.2, 3.3, 3.4, 3.5_

- [ ] 5.1 扩展CallManager支持视频通话
  - 在CallManager中添加视频通话支持，处理摄像头媒体流
  - 实现摄像头开关、前后摄像头切换、屏幕共享功能
  - _需求: 3.1, 3.2, 3.3, 3.4_

- [ ] 5.2 创建视频通话界面组件
  - 创建src/components/webrtc/VideoCallInterface.tsx视频通话界面
  - 支持本地和远程视频显示、画中画模式、媒体控制按钮
  - _需求: 3.2, 3.3, 3.4_

- [ ] 5.3 实现屏幕共享功能
  - 在WebRTCManager中添加屏幕共享支持，使用getDisplayMedia API
  - 在视频通话界面中集成屏幕共享控制和显示功能
  - _需求: 3.4_

- [ ] 6. 实现多人会议功能
  - 扩展通话管理器支持多人会议，处理多个peer连接
  - 创建会议界面组件，支持参与者管理和会议控制
  - _需求: 4.1, 4.2, 4.3, 4.4, 4.5_

- [ ] 6.1 扩展CallManager支持多人会议
  - 实现多人会议创建、邀请、加入、离开功能
  - 管理多个RTCPeerConnection连接，处理多路媒体流
  - _需求: 4.1, 4.2, 4.3_

- [ ] 6.2 创建会议界面组件
  - 创建src/components/webrtc/ConferenceInterface.tsx会议界面
  - 支持多人视频网格显示、参与者列表、会议控制功能
  - _需求: 4.2, 4.3, 4.4_

- [ ] 6.3 实现会议邀请和通知功能
  - 在消息系统中集成会议邀请消息类型
  - 实现会议邀请发送、接收、响应功能
  - _需求: 4.1, 4.2_

- [ ] 7. 实现群组功能
  - 创建群组管理器，支持群组创建、成员管理、权限控制
  - 实现群组消息功能，支持@提及、消息置顶、已读状态管理
  - 创建群组界面组件，支持群组聊天、群组通话、群组管理
  - _需求: 4.1, 4.2, 4.3, 4.4, 4.5_

- [ ] 7.1 创建GroupManager群组管理器
  - 创建src/services/groupManager.ts，实现群组创建、更新、删除功能
  - 支持群组成员管理、角色权限控制、群组信息查询
  - _需求: 4.1, 4.2, 4.3_

- [ ] 7.2 完善群组数据表结构
  - 在surreal_schemas.surql中添加message_read_status表，管理群组消息已读状态
  - 确保has_group_member关联表结构完整，支持群组成员权限管理
  - _需求: 4.1, 4.2_

- [ ] 7.3 实现群组消息功能
  - 扩展MessageService支持群组消息发送、@提及、消息置顶功能
  - 实现群组消息已读状态管理和未读计数功能
  - _需求: 4.2, 4.3, 4.4_

- [ ] 7.4 创建群组界面组件
  - 创建src/components/messages/GroupChatInterface.tsx群组聊天界面
  - 创建src/components/messages/GroupInfoPanel.tsx群组信息管理面板
  - 创建src/components/messages/GroupCreateDialog.tsx群组创建对话框
  - _需求: 4.1, 4.2, 4.3_

- [ ] 7.5 实现群组通话功能
  - 扩展CallManager支持群组通话发起、邀请、管理功能
  - 在群组聊天界面中集成群组通话发起和控制功能
  - _需求: 4.4, 4.5_

- [ ] 8. 集成消息中心界面
  - 扩展现有ChatInput组件支持文件选择和通话发起
  - 创建多媒体消息卡片组件，支持文件预览和通话回拨
  - _需求: 1.1, 1.4, 2.1, 3.1_

- [ ] 8.1 扩展ChatInput组件支持群组和私聊
  - 修改src/components/messages/ChatInput.tsx，添加文件选择和通话按钮
  - 支持群组@提及功能，集成文件上传处理和通话发起功能
  - _需求: 1.1, 2.1, 3.1, 4.2_

- [ ] 8.2 创建多媒体消息卡片组件
  - 创建src/components/messages/MediaMessageCard.tsx多媒体消息显示组件
  - 支持图片、视频、音频消息预览，通话消息回拨功能
  - _需求: 1.4, 1.5_

- [ ] 8.3 更新MessageListItem组件
  - 修改src/components/messages/MessageListItem.tsx，支持不同类型消息渲染
  - 集成MediaMessageCard组件，处理多媒体消息显示和群组消息特殊显示
  - _需求: 1.4, 1.5, 4.2_

- [ ] 8.4 集成群组功能到消息中心主界面
  - 修改src/pages/messages.tsx，添加群组列表和群组聊天切换功能
  - 集成群组创建、群组信息查看、群组成员管理功能
  - _需求: 4.1, 4.2, 4.3_

- [ ] 9. 实现移动端适配和优化
  - 优化移动端通话界面，支持横竖屏切换和触摸操作
  - 实现移动端文件选择，支持相机、相册、文件管理器
  - 优化移动端群组功能，支持触摸友好的群组管理界面
  - _需求: 6.1, 6.2, 6.3, 6.4, 6.5_

- [ ] 9.1 优化移动端通话界面
  - 修改AudioCallInterface和VideoCallInterface组件，适配移动端布局
  - 支持横竖屏自动切换、触摸友好的控制按钮，包括群组通话界面
  - _需求: 6.2, 6.3_

- [ ] 9.2 实现移动端文件选择功能
  - 在MediaFileHandler中添加移动端文件选择支持
  - 支持从相机拍照、相册选择、文件管理器选择文件
  - _需求: 6.1_

- [ ] 9.3 优化移动端群组功能
  - 优化群组聊天界面的移动端布局和交互
  - 实现移动端友好的群组成员管理和群组设置界面
  - _需求: 6.2, 6.3_

- [ ] 9.4 实现移动端后台通话支持
  - 添加通话状态持久化，支持应用后台时保持通话连接
  - 实现通话悬浮窗口显示和控制功能，包括群组通话
  - _需求: 6.4_

- [ ] 10. 实现网络适应性和错误处理
  - 创建网络质量检测和自适应功能，根据网络状况调整媒体质量
  - 实现WebRTC错误处理和恢复机制，提供用户友好的错误提示
  - _需求: 7.1, 7.2, 7.3, 7.4, 7.5_

- [ ] 10.1 创建NetworkAdaptation网络适应模块
  - 创建src/services/networkAdaptation.ts，实现网络质量检测
  - 支持根据网络状况自动调整视频质量和码率，包括群组通话优化
  - _需求: 7.1, 7.2_

- [ ] 10.2 实现WebRTC错误处理机制
  - 创建src/services/webrtcErrorHandler.ts，处理各类WebRTC错误
  - 提供用户友好的错误提示和恢复建议，包括群组通话错误处理
  - _需求: 7.3, 7.4_

- [ ] 10.3 实现连接重试和恢复功能
  - 在WebRTCManager中添加自动重连机制
  - 支持网络切换时的连接恢复和状态同步，包括群组通话重连
  - _需求: 7.4, 7.5_

- [ ] 11. 实现权限管理和安全控制
  - 集成现有权限系统，控制WebRTC功能的访问权限
  - 实现通话和文件传输的审计日志记录
  - 实现群组权限控制，确保群组操作安全性
  - _需求: 5.1, 5.2, 5.3, 5.4, 5.5_

- [ ] 11.1 集成WebRTC权限控制
  - 在现有权限系统中添加WebRTC相关权限定义
  - 在各WebRTC组件中集成权限检查逻辑，包括群组功能权限
  - _需求: 5.1, 5.2_

- [ ] 11.2 实现群组权限控制
  - 实现群组角色权限管理（群主、管理员、普通成员）
  - 集成案件相关群组的特殊权限控制逻辑
  - _需求: 5.1, 5.2, 4.1_

- [ ] 11.3 实现WebRTC审计日志
  - 创建WebRTC操作审计日志记录功能
  - 记录通话历史、文件传输记录、群组操作、权限使用情况
  - _需求: 5.4, 5.5_

- [ ] 11.4 实现用户在线状态管理
  - 创建user_webrtc_status表，管理用户WebRTC在线状态
  - 实现用户能力检测和状态同步功能
  - _需求: 5.3_

- [ ] 12. 编写测试用例
  - 为WebRTC核心功能编写单元测试，确保功能正确性
  - 创建集成测试验证端到端通话和文件传输流程
  - 编写群组功能专项测试，验证群组管理和群组通话功能
  - _需求: 所有需求的测试覆盖_

- [ ] 12.1 编写WebRTC服务单元测试
  - 为WebRTCManager、CallManager、MediaFileHandler、GroupManager编写单元测试
  - 测试核心功能的正确性和边界情况处理
  - _需求: 1.1-1.5, 2.1-2.5, 3.1-3.5, 4.1-4.5_

- [ ] 12.2 编写组件单元测试
  - 为WebRTC相关React组件编写单元测试，包括群组界面组件
  - 测试组件渲染、用户交互、状态管理等功能
  - _需求: 1.4, 1.5, 2.3, 2.4, 3.2, 3.3, 4.2, 4.3_

- [ ] 12.3 编写群组功能专项测试
  - 为群组创建、成员管理、群组消息、群组通话编写专项测试
  - 测试群组权限控制、@提及功能、消息置顶等特殊功能
  - _需求: 4.1-4.5_

- [ ] 12.4 创建端到端集成测试
  - 编写通话建立、文件传输、多人会议、群组功能的集成测试
  - 使用Playwright模拟真实用户操作场景，包括群组协作场景
  - _需求: 所有功能需求的集成测试_